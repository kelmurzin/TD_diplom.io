<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Russo+One&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Podkova:wght@500&family=Russo+One&display=swap');

      * {
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
      canvas {
        background: linear-gradient(to bottom, #ffffcc, #cc9900);
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <canvas id="canvasId"></canvas>
    <!-- <script src="/Lib.js"></script>
    <script src="/Menu.js"></script>
    <script src="/GameOver.js"></script>
    <script src="/Levels.js"></script>
    <script src="/Money.js"></script>
    <script src="/Enemy.js"></script>
    <script src="/FactoryPattern.js"></script>
    <script src="/Tower.js"></script>
    <script src="/Waves.js"></script>
    <script src="/BuildPlace.js"></script>
    <script src="/Effects.js"></script>
    <script src="/Game.js"></script> -->
    <script>

var Холст = document.getElementById("canvasId")
var Контекст = Холст.getContext("2d")

var Интервал_Времени = 0
var Предыдущая_Временная_Метка = 0

function Холст_Очистить() {
    Контекст.clearRect(0, 0, Холст.width, Холст.height)
}

var Движение = {
    Вверх: false,
    Вниз: false,
    Влево: false,
    Вправо: false
}

function Курсор_Изменить_Спрайт(Спрайт) {
    Холст.style.cursor = `url(${Спрайт.Картинка.src})${Спрайт.Ширина / 2} ${Спрайт.Высота / 2}, auto`
}

function Квадрат_Создать({
    Позиция_X = 0,
    Позиция_Y = 0,
    Ширина = 100,
    Высота = 100,
    Цвет = "black",
    Прозрачность = 1,
    Рамка = false,
    Цвет_Рамки = "white",
    Толщина_Рамки = 5
}) {
    Контекст.globalAlpha = Прозрачность

    Контекст.fillStyle = Цвет
    Контекст.fillRect(Позиция_X, Позиция_Y, Ширина, Высота)
    if (Рамка) {
        Контекст.lineWidth = Толщина_Рамки
        Контекст.strokeStyle = Цвет_Рамки
        Контекст.strokeRect(Позиция_X, Позиция_Y, Ширина, Высота)
    }
}

function Круг_Создать({
    Позиция_X,
    Позиция_Y,
    Радиус,
    Цвет,
    Прозрачность = 1,
    Рамка = false,
    Цвет_Рамки = "white",
    Толщина_Рамки = 5
}) {
    Контекст.globalAlpha = Прозрачность
    Контекст.fillStyle = Цвет
    Контекст.beginPath()
    Контекст.arc(Позиция_X, Позиция_Y, Радиус, 0, 2 * Math.PI)
    Контекст.fill()
    if (Рамка) {
        Контекст.lineWidth = Толщина_Рамки;
        Контекст.strokeStyle = Цвет_Рамки;
        Контекст.stroke();
    }
}

function Линия_Создать({
    Начало_Линии_Позиция_X = 0,
    Начало_Линии_Позиция_Y = 0,
    Конец_Линии_Позиция_X = 0,
    Конец_Линии_Позиция_Y = 0,
    Цвет = "black",
    Толщина_Линии = 6,
    Закруглить_Концы_Линии = false,
    Прозрачность = 1

}) {
    Контекст.globalAlpha = Прозрачность
    Контекст.strokeStyle = Цвет
    Контекст.beginPath()
    Контекст.lineWidth = Толщина_Линии
    Контекст.moveTo(Начало_Линии_Позиция_X, Начало_Линии_Позиция_Y)
    Контекст.lineTo(Конец_Линии_Позиция_X, Конец_Линии_Позиция_Y)
    if(Закруглить_Концы_Линии)
    Контекст.lineCap = "round"
    Контекст.stroke()
}

function Текст_Создать({
    Текст = "Текст",
    Позиция_X = 0,
    Позиция_Y = 0,
    Выравнивание_По = "",
    Цвет = "black",
    Размер_Шрифта = "20",
    Название_Шрифта = "Arial",
    Прозрачность = 1,
    Цвет_Тени = "",
    Смещение_Тени_По_X = 0,
    Смещение_Тени_По_Y = 0,

}) {
    this.Текст = Текст
    this.Позиция_X = Позиция_X
    this.Позиция_Y = Позиция_Y
  
        Обновить = function() {
            
            Контекст.font = `${Размер_Шрифта}px ${Название_Шрифта}`
            Контекст.globalAlpha = Прозрачность
            Контекст.shadowColor = Цвет_Тени
            Контекст.shadowOffsetX = Смещение_Тени_По_X
            Контекст.shadowOffsetY = Смещение_Тени_По_Y

            Контекст.fillStyle = Цвет
            Контекст.textAlign = Выравнивание_По
            Контекст.fillText(Текст, this.Позиция_X, this.Позиция_Y)
        }
    return this
}

class Текст {
    constructor({
    Текст = "Текст",
    Позиция_X = 0,
    Позиция_Y = 0,
    Выравнивание_По = "center",
    Цвет = "black",
    Размер_Шрифта = "25",
    Название_Шрифта = "Arial",
    Прозрачность = 1,
    Цвет_Тени = "black",
    Смещение_Тени_По_X = 2,
    Смещение_Тени_По_Y = 2,
    Тень = false,
}){
    this.Текст = Текст 
    this.Позиция_X = Позиция_X
    this.Позиция_Y = Позиция_Y
    this.Выравнивание_По = Выравнивание_По
    this.Цвет = Цвет
    this.Размер_Шрифта = Размер_Шрифта
    this.Название_Шрифта = Название_Шрифта
    this.Прозрачность = Прозрачность
    this.Цвет_Тени = Цвет_Тени
    this.Смещение_Тени_По_X = Смещение_Тени_По_X
    this.Смещение_Тени_По_Y = Смещение_Тени_По_Y
    this.Тень = Тень
    }
    Отрисовать(){
        Контекст.font = `${this.Размер_Шрифта}px ${this.Название_Шрифта}`
        Контекст.globalAlpha = this.Прозрачность
    if(this.Тень){
        Контекст.shadowColor = this.Цвет_Тени
        Контекст.shadowOffsetX = this.Смещение_Тени_По_X
        Контекст.shadowOffsetY = this.Смещение_Тени_По_Y
    }
        Контекст.fillStyle = this.Цвет
        Контекст.textAlign = this.Выравнивание_По
        Контекст.fillText(this.Текст, this.Позиция_X, this.Позиция_Y)
    }
    Обновить(Текст = ""){
        if(Текст != "")
        this.Текст = Текст
        
    this.Отрисовать()
    return this
    }
}

var Мышь = {
    Позиция_X: 0,
    Позиция_Y: 0,
    Ширина: 1,
    Высота: 1,
    Клик: false,
    Индекс: "192.168.1.58",
    Коллайдер: {
        Позиция_X: 0,
        Позиция_Y: 0,
        Смещение_По_X: 0,
        Смещение_По_Y: 0,
        Измененная_Позиция_X: 0,
        Измененная_Позиция_Y: 0,
        Ширина: 5,
        Высота: 5,
        Угол_В_Радианах: 0,
    }
}

class Объект {
    constructor({ Позиция_X, Позиция_Y, Скорость_По_X = 0, Скорость_По_Y = 0 }) {
        this.Позиция_X = Позиция_X
        this.Позиция_Y = Позиция_Y
        this.Скорость_По_X = Скорость_По_X
        this.Скорость_По_Y = Скорость_По_Y
        this.Столкнулся_С_Объектом = false
        this.Твердое_Тело = false
        this.Находиться_На_Земле = false
        this.Объект_Остановился = false
        this.Тег = null
        this.Угол_В_Радианах = 0
        this.Поворот_В_Градусах = 0
    }

    Движение_По_Клику(Мышь, Скорость_По_X = 20, Скорость_По_Y = 20) {

        let Движение_По_X
        let Движение_По_Y

        if (this.Ширина) {
            Движение_По_X = this.Позиция_X + this.Ширина / 2 - Мышь.Позиция_X
            Движение_По_Y = this.Позиция_Y + this.Высота / 2 - Мышь.Позиция_Y
        }
        if (Мышь.Позиция_X != this.Позиция_X) {
            this.Позиция_X -= Движение_По_X / Скорость_По_X
        }
        if (Мышь.Позиция_Y != this.Позиция_Y) {
            this.Позиция_Y -= Движение_По_Y / Скорость_По_Y
        }
    }

    Следовать_За_Объектом(Объект, Скорость) {

        this.Направление_По_X = Объект.Позиция_X - this.Позиция_X - this.Ширина / 2
        this.Направление_По_Y = Объект.Позиция_Y - this.Позиция_Y - this.Высота / 2
        this.Дистанция = Math.sqrt(this.Направление_По_X * this.Направление_По_X + this.Направление_По_Y * this.Направление_По_Y)
        this.Скорость_По_X = (this.Направление_По_X / this.Дистанция) * Скорость
        this.Скорость_По_Y = (this.Направление_По_Y / this.Дистанция) * Скорость
    }

    Коллайдер_Добавить() {

        if (this.Радиус && (this.Ширина || this.Высота)) {
            console.log("Неверные свойства коллайдера, есть (Радиус и Ширина/Высота) у объекта ", this)
            return
        }
        this.Коллайдер = {
            Позиция_X: this.Позиция_X,
            Позиция_Y: this.Позиция_Y,
            Смещение_По_X: 0,
            Смещение_По_Y: 0,
            Измененная_Позиция_X: 0,
            Измененная_Позиция_Y: 0,
            Угол_В_Радианах: this.Угол_В_Радианах,
            Поворот_В_Градусах: this.Поворот_В_Градусах
        }
        if (this.Радиус) {
            this.Коллайдер.Радиус = this.Радиус
        } else {
            this.Коллайдер.Ширина = this.Ширина
            this.Коллайдер.Высота = this.Высота
        }
        return this
    }

    Коллайдер_Изменить({ Позиция_X = 0, Позиция_Y = 0, Ширина = 1, Высота = 1, Радиус = "" }) {

        this.Коллайдер.Смещение_По_X = Позиция_X
        this.Коллайдер.Смещение_По_Y = Позиция_Y
        this.Коллайдер.Позиция_X = Позиция_X
        this.Коллайдер.Позиция_Y = Позиция_Y
        if (this.Радиус)
            this.Коллайдер.Радиус = Радиус
        else {
            this.Коллайдер.Ширина = Ширина
            this.Коллайдер.Высота = Высота
        }
        return this
    }

    Коллайдер_Обновлять() {

        if (this.Радиус && (this.Ширина || this.Высота)) {
            console.log("Неверные свойства коллайдера, есть (Радиус и Ширина/Высота) у ", this)
            return
        }
        this.Коллайдер.Угол_В_Радианах = this.Угол_В_Радианах
        this.Коллайдер.Поворот_В_Градусах = this.Поворот_В_Градусах
        this.Коллайдер.Измененная_Позиция_X = this.Позиция_X - this.Коллайдер.Смещение_По_X
        this.Коллайдер.Измененная_Позиция_Y = this.Позиция_Y - this.Коллайдер.Смещение_По_Y
        this.Коллайдер.Позиция_X = this.Коллайдер.Измененная_Позиция_X
        this.Коллайдер.Позиция_Y = this.Коллайдер.Измененная_Позиция_Y

        if (this.Радиус) {
            this.Коллайдер.Радиус = this.Радиус
        } else {
            this.Коллайдер.Ширина = this.Коллайдер.Ширина
            this.Коллайдер.Высота = this.Коллайдер.Высота
        }
        return this
    }

    Коллайдер_Показать() {

        Контекст.strokeStyle = "black"
        if (this.Коллайдер.Радиус)
            Контекст.stroke()
        else {
            Контекст.save()
            Контекст.translate(this.Коллайдер.Позиция_X + this.Коллайдер.Ширина / 2, this.Коллайдер.Позиция_Y + this.Коллайдер.Высота / 2)
            Контекст.rotate(this.Коллайдер.Угол_В_Радианах)
            Контекст.strokeRect(this.Коллайдер.Ширина / -2, this.Коллайдер.Высота / -2, this.Коллайдер.Ширина, this.Коллайдер.Высота)
            Контекст.restore()
        }
    }

    Кнопка_Добавить() {
        this.Кнопка = new Path2D
        this.Кнопка.rect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
        return this
    }

    Обновить() {
        this.Позиция_X += this.Скорость_По_X * Интервал_Времени
        this.Позиция_Y += this.Скорость_По_Y * Интервал_Времени
        if (this.Коллайдер) {
            this.Коллайдер_Обновлять()
        }
    }
}

class Квадрат extends Объект {
    constructor({
        Позиция_X,
        Позиция_Y,
        Ширина,
        Высота,
        Цвет = "black",
        Скорость_По_X = 0,
        Скорость_По_Y = 0,
        Твердое_Тело = false,
        Цвет_Тени = "",
        Смещение_Тени_По_X = 0,
        Смещение_Тени_По_Y = 0,
        Угол_В_Радианах = 0,
        Обводка = false,
        Толщина_Линии_Обводки = 1,
        Цвет_Обводки = "black",
        Прозрачность = 1
    }) {
        super({ Позиция_X, Позиция_Y, Скорость_По_X, Скорость_По_Y })
        this.Ширина = Ширина
        this.Высота = Высота
        this.Цвет = Цвет
        this.Твердое_Тело = Твердое_Тело
        this.Цвет_Тени = Цвет_Тени
        this.Смещение_Тени_По_X = Смещение_Тени_По_X
        this.Смещение_Тени_По_Y = Смещение_Тени_По_Y

        // Для TowerDefence
        this.Индекс_Точки_Пути = 0
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
        }
        this.Скорость = 2


        this.Угол_В_Радианах = Угол_В_Радианах
        this.Обводка = Обводка
        this.Толщина_Линии_Обводки = Толщина_Линии_Обводки
        this.Цвет_Обводки = Цвет_Обводки
        // this.Угол_В_Радианах = (-55 + 270) * (Math.PI / 180)
        this.Прозрачность = Прозрачность

    }

    Отрисовать() {
        Контекст.beginPath()
        
        Контекст.shadowColor = this.Цвет_Тени
        Контекст.shadowOffsetX = this.Смещение_Тени_По_X
        Контекст.shadowOffsetY = this.Смещение_Тени_По_Y
        Контекст.globalAlpha = this.Прозрачность
        Контекст.save()
        Контекст.translate(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2)
        Контекст.rotate(this.Угол_В_Радианах)
        Контекст.translate(-(this.Позиция_X + (this.Ширина / 2)), -(this.Позиция_Y + (this.Высота / 2)))
        if (this.Обводка) {
            Контекст.lineWidth = this.Толщина_Линии_Обводки
            Контекст.strokeStyle = this.Цвет_Обводки
            Контекст.strokeRect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
        }

        Контекст.fillStyle = this.Столкнулся_С_Объектом ? "#0099b0" : this.Цвет
        Контекст.fillRect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
        Контекст.restore()
    }

    Удалить() {
        Контекст.clearRect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
    }

    Клик() {
        let Объект = new Path2D
        Объект.rect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
        return Объект
    }

    Обновить() {
        super.Обновить()
        this.Отрисовать()
        // this.Позиция_X += this.Скорость_По_X * Интервал_Времени
        // this.Позиция_Y += this.Скорость_По_Y * Интервал_Времени
        return this
    }

    Повернуть() {

        this.Угол_В_Радианах = (-55 + 270) * (Math.PI / 180)
        // this.Скорость_По_X += 0.001
        Контекст.save()
        Контекст.translate(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2)
        Контекст.rotate(this.Угол_В_Радианах)
        Контекст.translate(-(this.Позиция_X + (this.Ширина / 2)), -(this.Позиция_Y + (this.Высота / 2)))
        Контекст.fillStyle = this.Цвет
        // Контекст.fillRect(this.Ширина / -2, this.Высота / -2, this.Ширина, this.Высота);
        Контекст.fillRect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
        // this.Обновить()
        Контекст.restore()

    }

    Перемещение_По_Точкам(Точки_Пути) {

        this.Отрисовать()
        let Точка_Пути = Точки_Пути[this.Индекс_Точки_Пути]
        let Дистанция_До_Точки_X = Точка_Пути.Позиция_X - this.Центр_Объекта.Позиция_X
        let Дистанция_До_Точки_Y = Точка_Пути.Позиция_Y - this.Центр_Объекта.Позиция_Y
        let Угол_В_Радианах = Math.atan2(Дистанция_До_Точки_Y, Дистанция_До_Точки_X)

        this.Позиция_X += Math.cos(Угол_В_Радианах)
        this.Позиция_Y += Math.sin(Угол_В_Радианах)
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
        }

        if (Math.round(this.Центр_Объекта.Позиция_X) === Math.round(Точка_Пути.Позиция_X) &&
            Math.round(this.Центр_Объекта.Позиция_Y) === Math.round(Точка_Пути.Позиция_Y) &&
            this.Индекс_Точки_Пути < Точки_Пути.length - 1) {
            this.Индекс_Точки_Пути++
        }

    }
}
class Круг extends Объект {
    constructor({
        Позиция_X,
        Позиция_Y,
        Скорость_По_X = 0,
        Скорость_По_Y = 0,
        Радиус = 1,
        Цвет = "black",
        Тег = "null",
        Твердое_Тело = false,
        Обводка = false,
        Толщина_Линии_Обводки = 1,
        Цвет_Обводки = "black",
        Прозрачность = 1
    }) {
        super({ Позиция_X, Позиция_Y, Скорость_По_X, Скорость_По_Y })

        this.Радиус = Радиус
        this.Цвет = Цвет
        this.Твердое_Тело = Твердое_Тело
        this.Тег = Тег

        this.Обводка = Обводка
        this.Толщина_Линии_Обводки = Толщина_Линии_Обводки
        this.Цвет_Обводки = Цвет_Обводки
        this.Прозрачность = Прозрачность
    }

    Отрисовать() {

        Контекст.fillStyle = this.Столкнулся_С_Объектом ? "#0099b0" : this.Цвет
        Контекст.beginPath()
        Контекст.globalAlpha = this.Прозрачность
        if (this.Обводка) {
            Контекст.lineWidth = this.Толщина_Линии_Обводки
            Контекст.strokeStyle = this.Цвет_Обводки
            Контекст.arc(this.Позиция_X, this.Позиция_Y, this.Радиус, 0, 2 * Math.PI)
            Контекст.stroke()

        }
        Контекст.arc(this.Позиция_X, this.Позиция_Y, this.Радиус, 0, 2 * Math.PI)
        Контекст.fill()
    }

    Обновить() {
        super.Обновить()
        this.Отрисовать()
        return this
    }
}

class Спрайт extends Объект {
    constructor({
        Позиция_X = 0,
        Позиция_Y = 0,
        Путь_К_Файлу = "",
        Масштаб = 1,
        Смещение_Спрайта_По_X = 0,
        Смещение_Спрайта_По_Y = 0,
        Скорость_По_X = 0,
        Скорость_По_Y = 0,
        Угол_В_Радианах = 0,
        Поворот_В_Градусах = 0,
        Прозрачность = 1
    }) {
        super({ Позиция_X, Позиция_Y, Скорость_По_X, Скорость_По_Y, Угол_В_Радианах, Поворот_В_Градусах})

        this.Путь_К_Файлу = Путь_К_Файлу
        this.Картинка = new Image()
        if (this.Путь_К_Файлу != ""){
            this.Картинка.src = `${this.Путь_К_Файлу}.png`     
        }
       
        this.Ширина = this.Картинка.width
        this.Высота = this.Картинка.height
        this.Масштаб = Масштаб
        this.Смещение_Спрайта_По_X = Смещение_Спрайта_По_X
        this.Смещение_Спрайта_По_Y = Смещение_Спрайта_По_Y
        this.Индекс_Точки_Пути = 0
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
            }
        this.Прозрачность = Прозрачность
    }
    

    Поменять_Спрайт(Путь_К_Файлу) {
        this.Путь_К_Файлу = Путь_К_Файлу
        this.Картинка = new Image()
        this.Картинка.src = `${this.Путь_К_Файлу}.png`
    }

    Отрисовать() {
        Контекст.globalAlpha = this.Прозрачность
        Контекст.shadowColor = ""
        Контекст.shadowOffsetX = 0
        Контекст.shadowOffsetY = 0
        this.Картинка.src = `${this.Путь_К_Файлу}.png`
        if (this.Поворот_В_Градусах != 0) {
            Контекст.drawImage(this.tCtx.canvas,- this.Картинка.width / 2 - this.Смещение_Спрайта_По_X * this.Масштаб,- this.Картинка.height / 2 - this.Смещение_Спрайта_По_Y * this.Масштаб,)
            Контекст.save()
            Контекст.translate(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2)
            Контекст.rotate(this.Поворот_В_Градусах)
            Контекст.drawImage(
                this.Картинка,
                - this.Картинка.width / 2 - this.Смещение_Спрайта_По_X * this.Масштаб,
                - this.Картинка.height / 2 - this.Смещение_Спрайта_По_Y * this.Масштаб,
            )
            Контекс.restore()
        } else {
         
            Контекст.drawImage(
                this.Картинка,
                this.Позиция_X,
                this.Позиция_Y,
                this.Картинка.width * this.Масштаб,
                this.Картинка.height * this.Масштаб
            )
            
        }
    
    }

    Обновить() {

        if (this.Путь_К_Файлу != "") {
            
            super.Обновить()
          
            this.Отрисовать()
            
            this.Центр_Объекта = {
                Позиция_X: this.Позиция_X + this.Ширина / 2,
                Позиция_Y: this.Позиция_Y + this.Высота / 2
            }
        }

    }

    Отзеркалить_По_Горизонтали() {
        Контекст.translate(this.Позиция_X, this.Позиция_Y)
        Контекст.scale(-1, 1)
        Контекст.drawImage(this.Картинка, 0, 0)
    }

    Отзеркалить_По_Вертикали() {
        Контекст.translate(this.Позиция_X, this.Позиция_Y)
        Контекст.scale(-1, -1)
        Контекст.drawImage(this.Картинка, 0, 0)
    }

    Вращать_За_Объектом(Объект) {

        this.Позиция_X += this.Скорость_По_X * Интервал_Времени
        this.Позиция_Y += this.Скорость_По_Y * Интервал_Времени
        if (!Объект.Радиус) {
            this.Угол_В_Радианах = Math.atan2((this.Позиция_Y + this.Высота / 2) - (Объект.Позиция_Y + Объект.Высота / 2), (this.Позиция_X + this.Ширина / 2) - (Объект.Позиция_X + Объект.Ширина / 2)) * (180 / Math.PI)
        } else {
            this.Угол_В_Радианах = Math.atan2((this.Позиция_Y + this.Высота / 2) - (Объект.Позиция_Y + Объект.Радиус / 2), (this.Позиция_X + this.Ширина / 2) - (Объект.Позиция_X + Объект.Радиус / 2)) * (180 / Math.PI)
        }
        this.Поворот_В_Градусах = (this.Угол_В_Радианах + 270) * (Math.PI / 180)

        Контекст.save()
        Контекст.translate(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2)
        Контекст.rotate(this.Поворот_В_Градусах)
        
        Контекст.drawImage(
            this.Картинка,
            - this.Картинка.width / 2 - this.Смещение_Спрайта_По_X * this.Масштаб,
            - this.Картинка.height / 2 - this.Смещение_Спрайта_По_Y * this.Масштаб,
        )
        
        Контекст.restore()
    }

    Вращать_За_Курсором() {

        this.Позиция_X += this.Скорость_По_X * Интервал_Времени
        this.Позиция_Y += this.Скорость_По_Y * Интервал_Времени

        Контекст.save()
        Контекст.translate(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2)
        Контекст.rotate(this.Поворот_В_Градусах)

        Контекст.drawImage(
            this.Картинка,
            - this.Картинка.width / 2 - this.Смещение_Спрайта_По_X,
            - this.Картинка.height / 2 - this.Смещение_Спрайта_По_Y,
        )
        Контекст.restore()
    }

    Перемещение_По_Точкам(Точки_Пути) {

        this.Отрисовать()
        let Точка_Пути = Точки_Пути[this.Индекс_Точки_Пути]
        let Дистанция_До_Точки_X = Точка_Пути.Позиция_X - this.Центр_Объекта.Позиция_X
        let Дистанция_До_Точки_Y = Точка_Пути.Позиция_Y - this.Центр_Объекта.Позиция_Y
        let Угол_В_Радианах = Math.atan2(Дистанция_До_Точки_Y, Дистанция_До_Точки_X)

        this.Позиция_X += Math.cos(Угол_В_Радианах)
        this.Позиция_Y += Math.sin(Угол_В_Радианах)
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
        }

        if (Math.round(this.Центр_Объекта.Позиция_X) === Math.round(Точка_Пути.Позиция_X) &&
            Math.round(this.Центр_Объекта.Позиция_Y) === Math.round(Точка_Пути.Позиция_Y) &&
            this.Индекс_Точки_Пути < Точки_Пути.length - 1) {
            this.Индекс_Точки_Пути++
        }

    }

    Следовать_За_Объектом(Объект, Скорость) {

        this.Направление_По_X = Объект.Позиция_X - this.Позиция_X
        this.Направление_По_Y = Объект.Позиция_Y - this.Позиция_Y
        this.Дистанция = Math.sqrt((this.Направление_По_X * this.Направление_По_X) + (this.Направление_По_Y * this.Направление_По_Y))
        this.Угол_В_Радианах = Math.atan2(this.Направление_По_Y, this.Направление_По_X) * 180 / Math.PI

        this.Скорость_По_X = (this.Направление_По_X / this.Дистанция) * Скорость
        this.Скорость_По_Y = (this.Направление_По_Y / this.Дистанция) * Скорость
    }

    Нарисовать_Круг(Цвет, Радиус) {
        Контекст.fillStyle = Цвет
        Контекст.beginPath()
        Контекст.arc(this.Позиция_X + this.Ширина / 2, this.Позиция_Y + this.Высота / 2, Радиус, 0, 2 * Math.PI)
        Контекст.fill()
    }
}

class Атлас extends Объект {
    constructor({
        Позиция_X,
        Позиция_Y,
        Путь_К_Файлу,
        Масштаб = 1,
        Скорость_По_X = 0,
        Скорость_По_Y = 0,
        Тег = "",
        Максимум_Кадров = 1,
        Скорость_Смены_Кадра = 7,
        Смещение_Спрайта_По_X = 0,
        Смещение_Спрайта_По_Y = 0,
        Спрайты = {},
        Поворот_В_Градусах = 0,
        Прозрачность = 1
    }) {
        super({ 
            Позиция_X,
            Позиция_Y,
            Скорость_По_X,
            Скорость_По_Y,
            Поворот_В_Градусах,
            Тег
        })
        this.Картинка = new Image()
        this.Картинка.src = `${Путь_К_Файлу}.png`
        this.Ширина = (this.Картинка.width * Масштаб) / Максимум_Кадров
        this.Высота = this.Картинка.height * Масштаб
        this.Масштаб = Масштаб
        this.Максимум_Кадров = Максимум_Кадров
        this.Текущий_Кадр = 0
        this.Прошедший_Кадр = 0
        this.Скорость_Смены_Кадра = Скорость_Смены_Кадра
        this.Смещение_Спрайта_По_X = Смещение_Спрайта_По_X
        this.Смещение_Спрайта_По_Y = Смещение_Спрайта_По_Y
        this.Индекс_Точки_Пути = 0
        this.Прозрачность = Прозрачность
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
        }
        this.Спрайты = Спрайты
        for (let Спрайт in this.Спрайты) {
            Спрайты[Спрайт].Картинка = new Image()
            Спрайты[Спрайт].Картинка.src = `${Спрайты[Спрайт].Путь_К_Файлу}.png`
        }
    }

    Отрисовать() {

        Контекст.globalAlpha = this.Прозрачность
        Контекст.shadowColor = ""
        Контекст.shadowOffsetX = 0
        Контекст.shadowOffsetY = 0

        Контекст.drawImage(
        this.Картинка,
        this.Текущий_Кадр * (this.Картинка.width / this.Максимум_Кадров),
        0,
        this.Картинка.width / this.Максимум_Кадров,
        this.Картинка.height,
        this.Позиция_X - this.Смещение_Спрайта_По_X,
        this.Позиция_Y - this.Смещение_Спрайта_По_Y,
        (this.Картинка.width / this.Максимум_Кадров) * this.Масштаб,

        this.Картинка.height * this.Масштаб)
    }

    Отзеркалить_По_Горизонтали() {
        Контекст.save()
        Контекст.translate(this.Позиция_X, this.Позиция_Y)
        Контекст.scale(-1, 1)
        Контекст.drawImage(this.Картинка, 0, 0, this.Картинка.width * -1, this.Картинка.height)
        Контекст.restore()
    }

    Отзеркалить_По_Вертикали() {
        Контекст.translate(this.Позиция_X, this.Позиция_Y)
        Контекст.scale(-1, -1)
        Контекст.drawImage(this.Картинка, 0, 0)
    }

    Кадр_Сменить() {
        this.Прошедший_Кадр++
        if (this.Прошедший_Кадр % this.Скорость_Смены_Кадра === 0) {
            if (this.Текущий_Кадр < this.Максимум_Кадров - 1) {
                this.Текущий_Кадр++
            } else {
                this.Текущий_Кадр = 0
            }
        }
    }

    Обновить() {
        super.Обновить()
        this.Отрисовать()
        this.Кадр_Сменить()
        // this.Скорость_По_Y += 2
        this.Центр_Объекта = {
            Позиция_X: this.Позиция_X + this.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Высота / 2
        }
    }


    Следовать_За_Объектом(Объект, Скорость) {

        this.Направление_По_X = Объект.Позиция_X - this.Позиция_X
        this.Направление_По_Y = Объект.Позиция_Y - this.Позиция_Y
        this.Дистанция = Math.sqrt((this.Направление_По_X * this.Направление_По_X) + (this.Направление_По_Y * this.Направление_По_Y))
        this.Угол_В_Радианах = Math.atan2(this.Направление_По_Y, this.Направление_По_X) * 180 / Math.PI

        this.Скорость_По_X = (this.Направление_По_X / this.Дистанция) * Скорость
        this.Скорость_По_Y = (this.Направление_По_Y / this.Дистанция) * Скорость
    }

    Установить_Анимацию(Состояние_Объекта) {

        if (this.Картинка !== this.Спрайты[Состояние_Объекта].Картинка) {
            this.Картинка = this.Спрайты[Состояние_Объекта].Картинка
            this.Максимум_Кадров = this.Спрайты[Состояние_Объекта].Максимум_Кадров
            this.Текущий_Кадр = 0
        }
    }
}

class Камера {
    constructor(Настройки = {}) {
        this.Дистанция = Настройки.Дистанция || 1000.0
        this.Направление = Настройки.Исходное_Положение || [0, 0]
        this.Поле_Зрения = Настройки.Поле_Зрения || Math.PI / 4.0
        this.Окно_Камеры = {
            Лево: 0,
            Право: 0,
            Верх: 0,
            Низ: 0,
            Ширина: 0,
            Высота: 0,
            Масштаб: [Настройки.Масштаб_X || 1.0, Настройки.Масштаб_Y || 1.0]
        }
        this.Создать()
    }

    Создать() {
        this.Обновить_Окно_Камеры()
    }

    Начать_Отрисовку() {
        Контекст.save()
        this.Применить_Масштаб()
        this.Применить_Перемещение()
    }

    Закончить_Отрисовку() {
        Контекст.restore()
    }

    Применить_Масштаб() {
        Контекст.scale(this.Окно_Камеры.Масштаб[0], this.Окно_Камеры.Масштаб[1])
    }

    Применить_Перемещение() {
        Контекст.translate(-this.Окно_Камеры.Лево, -this.Окно_Камеры.Верх)
    }

    Обновить_Окно_Камеры() {
        this.aspectRatio = Контекст.canvas.width / Контекст.canvas.height
        this.Окно_Камеры.Ширина = this.Дистанция * Math.tan(this.Поле_Зрения)
        this.Окно_Камеры.Высота = this.Окно_Камеры.Ширина / this.aspectRatio
        this.Окно_Камеры.Лево = this.Направление[0] - (this.Окно_Камеры.Ширина / 2.0)
        this.Окно_Камеры.Верх = this.Направление[1] - (this.Окно_Камеры.Высота / 2.0)
        this.Окно_Камеры.Право = this.Окно_Камеры.Лево + this.Окно_Камеры.Ширина
        this.Окно_Камеры.Низ = this.Окно_Камеры.Верх + this.Окно_Камеры.Высота
        this.Окно_Камеры.Масштаб[0] = Контекст.canvas.width / this.Окно_Камеры.Ширина
        this.Окно_Камеры.Масштаб[1] = Контекст.canvas.height / this.Окно_Камеры.Высота
    }

    Увеличить_До(z) {
        this.Дистанция = z * 1000
        this.Обновить_Окно_Камеры()
    }

    Следовать_За_Объектом(Объект) {
        if (Объект.Радиус) {
            this.Направление[0] = Объект.Позиция_X + Объект.Радиус
            this.Направление[1] = Объект.Позиция_Y + Объект.Радиус
        } else {
            this.Направление[0] = (Объект.Позиция_X + Объект.Ширина / 2)
            this.Направление[1] = (Объект.Позиция_Y + Объект.Высота / 2) - 100
        }
        this.Обновить_Окно_Камеры()
    }

    Преобразить_Координаты_Экрана_В_Мировые_Координаты(Позиция_X, Позиция_Y, Объект) {
        Объект = Объект || {}
        Объект.x = (Позиция_X / this.Окно_Камеры.Масштаб[0]) + this.Окно_Камеры.Лево
        Объект.y = (Позиция_Y / this.Окно_Камеры.Масштаб[1]) + this.Окно_Камеры.Верх
        return Объект
    }

    Преобразить_Мировые_Координаты_В_Координаты_Экрана(Позиция_X, Позиция_Y, Объект) {
        Объект = Объект || {}
        Объект.x = (Позиция_X - this.Окно_Камеры.Лево) * (this.Окно_Камеры.Масштаб[0])
        Объект.y = (Позиция_Y - this.Окно_Камеры.Верх) * (this.Окно_Камеры.Масштаб[1])
        return Объект
    }
}

class Таблица {
    constructor({
        Данные = "",
        Позиция_X = 100,
        Позиция_Y = 100,
        Количество_Строк = 5,
        Количество_Колонок = 5,
        Ширина_Ячейки = 100,
        Высота_Ячейки = 100,
        Цвет_Тени = "",
        Смещение_Тени_По_X = 0,
        Смещение_Тени_По_Y = 0,
    }) {

        this.Данные = Данные
        this.Позиция_X = Позиция_X
        this.Позиция_Y = Позиция_Y
        this.Количество_Строк = Количество_Строк
        this.Количество_Колонок = Количество_Колонок
        this.Ширина_Ячейки = Ширина_Ячейки
        this.Высота_Ячейки = Высота_Ячейки
        this.Активные_Ячейки = []
        this.Активная_таблица
        this.Активировать_Ячейки = []
        this.Цвет_Тени = Цвет_Тени
        this.Смещение_Тени_По_X = Смещение_Тени_По_X
        this.Смещение_Тени_По_Y = Смещение_Тени_По_Y

        for (let i = 1; i < Object.entries(Данные).length + 1; i++) {
            this.Активировать_Ячейки[i] = new Path2D
            this.Активировать_Ячейки[i].rect(this.Позиция_X, this.Позиция_Y +
            (i * this.Высота_Ячейки), this.Ширина_Ячейки, this.Высота_Ячейки)
            this.Активные_Ячейки.push(this.Активировать_Ячейки[i])
        }
    }

    Таблица_Отрисовать() {

        Контекст.shadowColor = this.Цвет_Тени
        Контекст.shadowOffsetX = this.Смещение_Тени_По_X
        Контекст.shadowOffsetY = this.Смещение_Тени_По_Y

        for (let i = 1; i < Object.entries(this.Данные).length + 1; i++) {
            this.Активировать_Ячейки[i].rect(this.Позиция_X, this.Позиция_Y + (i * this.Высота_Ячейки), this.Ширина_Ячейки, this.Высота_Ячейки)
        }

        let Свойства_Имена = Object.keys(this.Данные[0])

        this.Активная_таблица = new Path2D
        this.Активная_таблица.rect(this.Позиция_X, this.Позиция_Y, this.Ширина_Ячейки * this.Количество_Колонок, this.Высота_Ячейки)

        for (let i = 0; i < this.Количество_Строк; i++) {
            for (let k = 0; k < this.Количество_Колонок; k++) {

                Контекст.fillStyle = "#f5f5f5"
                Контекст.fillRect(this.Позиция_X + (k * this.Ширина_Ячейки), this.Позиция_Y + (i * this.Высота_Ячейки), this.Ширина_Ячейки, this.Высота_Ячейки)
                Контекст.beginPath()
                Контекст.strokeStyle = "#716e77"
                Контекст.lineWidth = 3
                Контекст.strokeRect(this.Позиция_X + (k * this.Ширина_Ячейки), this.Позиция_Y + (i * this.Высота_Ячейки), this.Ширина_Ячейки, this.Высота_Ячейки)
                Контекст.closePath()
            }
        }

        let Граница_Ширина = (Object.entries(this.Данные[0]).length) * this.Ширина_Ячейки
        let Граница_Высота = (this.Данные.length + 1) * this.Высота_Ячейки

        for (let i = this.Высота_Ячейки * 2, Количество_Заполняемых_Строк = 0; i <= Граница_Высота; i += this.Высота_Ячейки) {

            for (let k = 0, Количество_Заполняемых_Столбцов = 0; k < Граница_Ширина; k += this.Ширина_Ячейки) {

                Контекст.font = "normal 16px Verdana"
                Контекст.fillStyle = "black"
                Контекст.fillText(
                    (this.Данные[Количество_Заполняемых_Строк])[Свойства_Имена[Количество_Заполняемых_Столбцов]],
                    this.Позиция_X + k + (this.Количество_Строк),
                    this.Позиция_Y + i - 10)

                ++Количество_Заполняемых_Столбцов
            }
            ++Количество_Заполняемых_Строк
        }
        for (let i = 0, Количество_Заполняемых_Столбцов = 0; i < Граница_Ширина; i += this.Ширина_Ячейки) {

            Контекст.font = "bold 16px Verdana"
            Контекст.fillStyle = "black"
            Контекст.fillText(Свойства_Имена[Количество_Заполняемых_Столбцов], this.Позиция_X + (this.Количество_Строк) + i, this.Позиция_Y + 25)

            ++Количество_Заполняемых_Столбцов
        }
    }
}

function Столкновение_Определить(п_Первый_Объект, п_Второй_Объект) {

    if (!п_Первый_Объект.Коллайдер || !п_Второй_Объект.Коллайдер) {
        console.log("Нету коллайдера")
        return
    }

    let Первый_Объект = п_Первый_Объект.Коллайдер
    let Второй_Объект = п_Второй_Объект.Коллайдер
    let Фигура = Первый_Объект.Радиус ? "Круг" : "Квадрат"

    switch (Фигура) {

        case "Квадрат":
            if (Второй_Объект.Радиус) {
                return Определить_Пересечение_Между_Кругом_И_Квадратом(Второй_Объект, Первый_Объект)

            } else {
                return Определить_Пересечение_Квадратов(Первый_Объект, Второй_Объект)
            }

        case "Круг":
            if (Второй_Объект.Радиус) {
                return Определить_Пересечение_Кругов(Первый_Объект, Второй_Объект)
            } else {
                return Определить_Пересечение_Между_Кругом_И_Квадратом(Первый_Объект, Второй_Объект)
            }

        default:
            console.log("Ошибка")
            break
    }
}

function Определить_Пересечение_Квадратов(Первый_Объект, Второй_Объект) {

    if (Первый_Объект.Угол_В_Радианах != 0 || Второй_Объект.Угол_В_Радианах != 0) {
        return Столкновение_Фигур_При_Вращении(Первый_Объект, Второй_Объект)
    }

    if (Второй_Объект.Позиция_X > Первый_Объект.Ширина + Первый_Объект.Позиция_X ||
        Первый_Объект.Позиция_X > Второй_Объект.Ширина + Второй_Объект.Позиция_X ||
        Второй_Объект.Позиция_Y > Первый_Объект.Высота + Первый_Объект.Позиция_Y ||
        Первый_Объект.Позиция_Y > Второй_Объект.Высота + Второй_Объект.Позиция_Y) {
        return false
    } else
        return true
}
// Определить пересечение квадратов при вращении
function Точки_Пересечения_Найти(Позиция_X_В_Центре_Объекта, Позиция_Y_В_Центре_Объекта, Позиция_X, Позиция_Y, Объект_Поворот) {

    Объект_Поворот = (Объект_Поворот + 270) * (Math.PI / 180)

    let Направление_По_X = Позиция_X - Позиция_X_В_Центре_Объекта
    let Направление_По_Y = Позиция_Y - Позиция_Y_В_Центре_Объекта
    let Дистанция = Math.sqrt(Направление_По_X * Направление_По_X + Направление_По_Y * Направление_По_Y)
    let Исходный_Угол = Math.atan2(Направление_По_Y, Направление_По_X)
    let Вращение_По_X = Позиция_X_В_Центре_Объекта + Дистанция * Math.cos(Исходный_Угол + Объект_Поворот)
    let Вращение_По_Y = Позиция_Y_В_Центре_Объекта + Дистанция * Math.sin(Исходный_Угол + Объект_Поворот)

    return {
        Позиция_X: Вращение_По_X,
        Позиция_Y: Вращение_По_Y
    }
}

function Получить_Координаты_Повернутой_Фигуры(Объект) {

    let Позиция_X_В_Центре_Объекта = Объект.Позиция_X + (Объект.Ширина / 2)
    let Позиция_Y_В_Центре_Объекта = Объект.Позиция_Y + (Объект.Высота / 2)

    let Точка_Верхняя_Левая = Точки_Пересечения_Найти(Позиция_X_В_Центре_Объекта, Позиция_Y_В_Центре_Объекта, Объект.Позиция_X, Объект.Позиция_Y, Объект.Поворот_В_Градусах)
    let Точка_Верхняя_Правая = Точки_Пересечения_Найти(Позиция_X_В_Центре_Объекта, Позиция_Y_В_Центре_Объекта, Объект.Позиция_X + Объект.Ширина, Объект.Позиция_Y, Объект.Поворот_В_Градусах)
    let Точка_Нижняя_Левая = Точки_Пересечения_Найти(Позиция_X_В_Центре_Объекта, Позиция_Y_В_Центре_Объекта, Объект.Позиция_X, Объект.Позиция_Y + Объект.Высота, Объект.Поворот_В_Градусах)
    let Точка_Нижняя_Правая = Точки_Пересечения_Найти(Позиция_X_В_Центре_Объекта, Позиция_Y_В_Центре_Объекта, Объект.Позиция_X + Объект.Ширина, Объект.Позиция_Y + Объект.Высота, Объект.Поворот_В_Градусах)

    return {
        Точка_Верхняя_Левая: Точка_Верхняя_Левая,
        Точка_Верхняя_Правая: Точка_Верхняя_Правая,
        Точка_Нижняя_Левая: Точка_Нижняя_Левая,
        Точка_Нижняя_Правая: Точка_Нижняя_Правая
    }
}

function Вершина_Фигуры(Позиция_X, Позиция_Y) {
    this.Позиция_X = Позиция_X
    this.Позиция_Y = Позиция_Y
}

function Многоугольник_Создать(Вершины, Ребра) {
    this.Вершины = Вершины
    this.Ребра = Ребра
}

function Обнаружение_Столкновений_С_Использованием_Теоремы_О_Разделяющей_Оси(Многоугольник_А, Многоугольник_Б) {

    let Линия_Перпендикуляра = null
    let Точка = 0
    let Перпендикуляры = []
    let Скалярное_Произведение_Минимальное_У_Многоугольника_А = null
    let Скалярное_Произведение_Максимальное_У_Многоугольника_А = null
    let Скалярное_Произведение_Минимальное_У_Многоугольника_Б = null
    let Скалярное_Произведение_Максимальное_У_Многоугольника_Б = null

    for (let i = 0; i < Многоугольник_А.Ребра.length; i++) {
        Линия_Перпендикуляра = new Вершина_Фигуры(-Многоугольник_А.Ребра[i].Позиция_Y,
            Многоугольник_А.Ребра[i].Позиция_X)
        Перпендикуляры.push(Линия_Перпендикуляра)
    }

    for (let i = 0; i < Многоугольник_Б.Ребра.length; i++) {
        Линия_Перпендикуляра = new Вершина_Фигуры(-Многоугольник_Б.Ребра[i].Позиция_Y,
            Многоугольник_Б.Ребра[i].Позиция_X)
        Перпендикуляры.push(Линия_Перпендикуляра)
    }

    for (let i = 0; i < Перпендикуляры.length; i++) {

        Скалярное_Произведение_Минимальное_У_Многоугольника_А = null
        Скалярное_Произведение_Максимальное_У_Многоугольника_А = null
        Скалярное_Произведение_Минимальное_У_Многоугольника_Б = null
        Скалярное_Произведение_Максимальное_У_Многоугольника_Б = null

        for (let j = 0; j < Многоугольник_А.Вершины.length; j++) {
            Точка = Многоугольник_А.Вершины[j].Позиция_X *
                Перпендикуляры[i].Позиция_X +
                Многоугольник_А.Вершины[j].Позиция_Y *
                Перпендикуляры[i].Позиция_Y

            if (Скалярное_Произведение_Максимальное_У_Многоугольника_А === null || Точка > Скалярное_Произведение_Максимальное_У_Многоугольника_А) {
                Скалярное_Произведение_Максимальное_У_Многоугольника_А = Точка
            }
            if (Скалярное_Произведение_Минимальное_У_Многоугольника_А === null || Точка < Скалярное_Произведение_Минимальное_У_Многоугольника_А) {
                Скалярное_Произведение_Минимальное_У_Многоугольника_А = Точка
            }
        }

        for (let j = 0; j < Многоугольник_Б.Вершины.length; j++) {
            Точка = Многоугольник_Б.Вершины[j].Позиция_X *
                Перпендикуляры[i].Позиция_X +
                Многоугольник_Б.Вершины[j].Позиция_Y *
                Перпендикуляры[i].Позиция_Y

            if (Скалярное_Произведение_Максимальное_У_Многоугольника_Б === null || Точка > Скалярное_Произведение_Максимальное_У_Многоугольника_Б) {
                Скалярное_Произведение_Максимальное_У_Многоугольника_Б = Точка
            }
            if (Скалярное_Произведение_Минимальное_У_Многоугольника_Б === null || Точка < Скалярное_Произведение_Минимальное_У_Многоугольника_Б) {
                Скалярное_Произведение_Минимальное_У_Многоугольника_Б = Точка
            }
        }

        if ((Скалярное_Произведение_Минимальное_У_Многоугольника_А < Скалярное_Произведение_Максимальное_У_Многоугольника_Б && Скалярное_Произведение_Минимальное_У_Многоугольника_А > Скалярное_Произведение_Минимальное_У_Многоугольника_Б) ||
            (Скалярное_Произведение_Минимальное_У_Многоугольника_Б < Скалярное_Произведение_Максимальное_У_Многоугольника_А && Скалярное_Произведение_Минимальное_У_Многоугольника_Б > Скалярное_Произведение_Минимальное_У_Многоугольника_А)) {
            continue
        }
        else {
            return false
        }
    }
    return true
}

function Столкновение_Фигур_При_Вращении(Первый_Объект, Второй_Объект) {

    let Фигура_А = Первый_Объект
    let Фигура_Б = Второй_Объект

    let Фигура_А_Координаты_XY = Получить_Координаты_Повернутой_Фигуры(Фигура_А)
    let Фигура_Б_Координаты_XY = Получить_Координаты_Повернутой_Фигуры(Фигура_Б)

    let Фигура_А_Вершины = [
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_X, Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_X, Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_X, Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_X, Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y),
    ]

    let Фигура_А_Ребра = [
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_X - Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_X, Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y - Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_X - Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_X, Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y - Фигура_А_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_X - Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_X, Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y - Фигура_А_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y),
        new Вершина_Фигуры(Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_X - Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_X, Фигура_А_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y - Фигура_А_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y)
    ]

    let Фигура_Б_Вершины = [
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y),
    ]

    let Фигура_Б_Ребра = [
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_X - Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y - Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_X - Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y - Фигура_Б_Координаты_XY.Точка_Нижняя_Правая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_X - Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y - Фигура_Б_Координаты_XY.Точка_Нижняя_Левая.Позиция_Y),
        new Вершина_Фигуры(Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_X - Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_X, Фигура_Б_Координаты_XY.Точка_Верхняя_Правая.Позиция_Y - Фигура_Б_Координаты_XY.Точка_Верхняя_Левая.Позиция_Y)
    ]

    let Многоугольник_А = new Многоугольник_Создать(Фигура_А_Вершины, Фигура_А_Ребра)
    let Многоугольник_Б = new Многоугольник_Создать(Фигура_Б_Вершины, Фигура_Б_Ребра)

    if (Обнаружение_Столкновений_С_Использованием_Теоремы_О_Разделяющей_Оси(Многоугольник_А, Многоугольник_Б)) {
        return true
    } else {
        return false
    }
}
//

function Определить_Пересечение_Кругов(Первый_Объект, Второй_Объект) {

    // if (!п_Первый_Объект.Коллайдер || !п_Второй_Объект.Коллайдер) {
    //     console.log("Нету коллайдера");
    //     return
    // }

    // let Первый_Объект = п_Первый_Объект.Коллайдер
    // let Второй_Объект = п_Второй_Объект.Коллайдер

    let Дистанция_Между_Объектами = (Первый_Объект.Позиция_X - Второй_Объект.Позиция_X) *
        (Первый_Объект.Позиция_X - Второй_Объект.Позиция_X) +
        (Первый_Объект.Позиция_Y - Второй_Объект.Позиция_Y) *
        (Первый_Объект.Позиция_Y - Второй_Объект.Позиция_Y)

    return Дистанция_Между_Объектами <= ((Первый_Объект.Радиус + Второй_Объект.Радиус) *
        (Первый_Объект.Радиус + Второй_Объект.Радиус))
}

function Определить_Пересечение_Между_Кругом_И_Квадратом(Круг, Квадрат) {

    let Позиция_X = Круг.Позиция_X
    let Позиция_Y = Круг.Позиция_Y

    if (Квадрат.Угол_В_Радианах != 0) {
        return Столкновение_Круга_С_Прямоугольником_При_Вращении(Круг, Квадрат)
    }

    if (Круг.Позиция_X < Квадрат.Позиция_X) {
        Позиция_X = Квадрат.Позиция_X
    } else if (Круг.Позиция_X > Квадрат.Позиция_X + Квадрат.Ширина) {
        Позиция_X = Квадрат.Позиция_X + Квадрат.Ширина
    }
    if (Круг.Позиция_Y < Квадрат.Позиция_Y) {
        Позиция_Y = Квадрат.Позиция_Y
    } else if (Круг.Позиция_Y > Квадрат.Позиция_Y + Квадрат.Высота) {
        Позиция_Y = Квадрат.Позиция_Y + Квадрат.Высота
    }

    let Дистанция_По_X = Круг.Позиция_X - Позиция_X
    let Дистанция_По_Y = Круг.Позиция_Y - Позиция_Y
    let Дистанция = Math.sqrt(Дистанция_По_X * Дистанция_По_X + Дистанция_По_Y * Дистанция_По_Y)

    if (Дистанция < Круг.Радиус) {
        return true
    } else
        return false
}

const Дистанция_Между_Кругом_И_Прямоугольником_Найти = (Положение_Круга_По_X, Положение_Круга_По_Y, Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга, Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга) => {
    const а = Math.abs(Положение_Круга_По_X - Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга)
    const б = Math.abs(Положение_Круга_По_Y - Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга)

    return Math.sqrt((а * а) + (б * б))
}


function Столкновение_Круга_С_Прямоугольником_При_Вращении(Круг, Прямоугольник) {

    let Прямоугольник_Центр_Позиции_X = Прямоугольник.Позиция_X + Прямоугольник.Ширина / 2
    let Прямоугольник_Центр_Позиции_Y = Прямоугольник.Позиция_Y + Прямоугольник.Высота / 2
    let Угол_В_Радианах = (Прямоугольник.Поворот_В_Градусах + 270) * (Math.PI / 180)

    const Положение_Круга_По_X = Math.cos(-Угол_В_Радианах) * (Круг.Позиция_X - Прямоугольник_Центр_Позиции_X) -
        Math.sin(-Угол_В_Радианах) * (Круг.Позиция_Y - Прямоугольник_Центр_Позиции_Y) + Прямоугольник_Центр_Позиции_X
    const Положение_Круга_По_Y = Math.sin(-Угол_В_Радианах) * (Круг.Позиция_X - Прямоугольник_Центр_Позиции_X) +
        Math.cos(-Угол_В_Радианах) * (Круг.Позиция_Y - Прямоугольник_Центр_Позиции_Y) + Прямоугольник_Центр_Позиции_Y

    let Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга, Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга

    if (Положение_Круга_По_X < Прямоугольник.Позиция_X)
        Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга = Прямоугольник.Позиция_X
    else if (Положение_Круга_По_X > Прямоугольник.Позиция_X + Прямоугольник.Ширина)
        Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга = Прямоугольник.Позиция_X + Прямоугольник.Ширина
    else
        Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга = Положение_Круга_По_X

    if (Положение_Круга_По_Y < Прямоугольник.Позиция_Y)
        Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга = Прямоугольник.Позиция_Y
    else if (Положение_Круга_По_Y > Прямоугольник.Позиция_Y + Прямоугольник.Высота)
        Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга = Прямоугольник.Позиция_Y + Прямоугольник.Высота
    else
        Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга = Положение_Круга_По_Y

    const Дистанция = Дистанция_Между_Кругом_И_Прямоугольником_Найти(Положение_Круга_По_X, Положение_Круга_По_Y, Ближайшая_Точка_По_X_Прямоугольника_К_Центру_Круга, Ближайшая_Точка_По_Y_Прямоугольника_К_Центру_Круга)
    if (Дистанция < Круг.Радиус)
        return true
    else
        return false
}

function Проверить_Коллизии_Между_Массивами(Первый_Массив, Второй_Массив) {

    let Первый_Объект
    let Второй_Объект

    for (let i = 0; i < Первый_Массив.length; i++) {
        Первый_Объект = Первый_Массив[i]
        for (let k = 0; k < Второй_Массив.length; k++) {
            Второй_Объект = Второй_Массив[k]
            if (Второй_Объект.Радиус) {
                if (Определить_Пересечение_Кругов(Первый_Объект, Второй_Объект)) {
                    return [i, k, Первый_Массив[i], Второй_Массив[k]]
                }
            } else {
                if (Определить_Пересечение_Между_Кругом_И_Квадратом(Первый_Объект, Второй_Объект)) {
                    return [i, k, Первый_Массив[i], Второй_Массив[k]]
                }
            }
        }
    }
}

function Действие_С_Объектом(Событие, Массив_Объектов, Объект) {

    switch (Событие) {
        case "Уничтожить":
            Массив_Объектов.splice(Объект, 1)
            break
        case "Покрасить":
            Объект.Цвет = "black"
            break
    }
}

function Объекты_В_Массиве_Обновить(Массив_Объектов,Параметр = null) {
    Массив_Объектов.forEach(Объект => {
        Объект.Обновить(Параметр)
    })
}

function Стрельба_Мышкой(Мышь, Созданный_Объект, Пуля_Скорость, Массив_Пуль, Смещение_По_X = 0, Смещение_По_Y = 0, Тег = null, Цвет = "red", Смещение_Угла = 0) {

    let Угол_Направления_Объекта = Math.atan2(Мышь.Позиция_Y - Созданный_Объект.Позиция_Y,
        Мышь.Позиция_X - Созданный_Объект.Позиция_X)

    let Направление_Перемещения_Пули = {
        x: Math.cos(Угол_Направления_Объекта) * Пуля_Скорость,
        y: Math.sin(Угол_Направления_Объекта) * Пуля_Скорость
    }

    Массив_Пуль.push(new Круг({
        Позиция_X: Созданный_Объект.Позиция_X + Смещение_По_X,
        Позиция_Y: Созданный_Объект.Позиция_Y + Смещение_По_Y,
        Скорость_По_X: Направление_Перемещения_Пули.x + Смещение_Угла,
        Скорость_По_Y: Направление_Перемещения_Пули.y + Смещение_Угла,
        Радиус: 3,
        Цвет: Цвет,
        Тег: Тег
    }))
    return Массив_Пуль
}

function Клик_На_Объект(Мышь, Объект) {

    // console.log(Мышь,Объект);
    if (Столкновение_Определить(Мышь, Объект)) {

        return Объект
    }
    // for (let i = 0; i < Массив_Объектов.length; i++) {
    //     let Объект_Массива = Массив_Объектов[i]
    //     if (!Объект_Массива.Столкнулся_С_Объектом) {
    //         if (!Объект_Массива.Радиус) {
    //             if (Определить_Пересечение_Квадратов(Мышь, Объект_Массива)) {
    //                 return Объект_Массива
    //             }
    //         }
    //     } else {
    //         if (Определить_Пересечение_Между_Кругом_И_Квадратом(Объект_Массива, Мышь)) {
    //             return Объект_Массива
    //         }
    //     }

    // }
}

function Массив_Удалить_Элемент(Массив, Индекс) {
    Массив.splice(Индекс, 1)
}

// function Объект_Удалить_Из_Массива_За_Границей_Экрана(Массив) {

//     Массив.forEach(function (Объект, Индекс) {

//         if (Объект.Позиция_X + Объект.Ширина < 0 || Объект.Позиция_X - Объект.Ширина > Холст.width
//             || Объект.Позиция_Y + Объект.Высота < 0 || Объект.Позиция_Y - Объект.Высота > Холст.height) {
//             setTimeout(Массив_Удалить_Элемент(Массив, Индекс), 0)
//         }
//     })
// }

function Проверка_Коллизии_Между_Объектом_И_Массивом(Объект, Массив) {

    let Фигура = Объект.Радиус ? "Круг" : "Квадрат"

    let Первый_Объект = Объект
    let Второй_Объект
    Первый_Объект.Столкнулся_С_Объектом = false

    for (let i = 0; i < Массив.length; i++) {
        Массив[i].Столкнулся_С_Объектом = false
    }

    for (let i = 0; i < Массив.length; i++) {
        Второй_Объект = Массив[i]

        switch (Фигура) {

            case "Квадрат":
                if (Второй_Объект.Радиус) {
                    if (Определить_Пересечение_Между_Кругом_И_Квадратом(Второй_Объект, Первый_Объект)) {
                        return [i, Массив[i]]
                    }
                } else {
                    if (Определить_Пересечение_Квадратов(Первый_Объект, Второй_Объект)) {
                        return [i, Массив[i]]
                    }
                }
                break

            case "Круг":
                if (Второй_Объект.Радиус) {
                    if (Определить_Пересечение_Кругов(Первый_Объект, Второй_Объект)) {
                        return [i, Массив[i]]
                    }
                } else {
                    if (Определить_Пересечение_Между_Кругом_И_Квадратом(Первый_Объект, Второй_Объект)) {
                        return [i, Массив[i]]
                    }
                }
                break

            default:
                console.log("Ошибка")
                break
        }
    }
}

function Объект_Проверка_Выхода_За_Границы_Экрана(п_Объект, Границы = null) {

    Холст = Границы ? Границы : Холст
    let Объект = п_Объект.Коллайдер
    if (Объект.Радиус) {
        if (Объект.Позиция_X + Объект.Радиус < Объект.Радиус ||
            Объект.Позиция_X > Холст.width - Объект.Радиус ||
            Объект.Позиция_Y + Объект.Радиус < Объект.Радиус ||
            Объект.Позиция_Y > Холст.height - Объект.Радиус)
            return true
    } else {
        if (Объект.Позиция_X + Объект.Ширина < Объект.Ширина ||
            Объект.Позиция_X > Холст.width - Объект.Ширина ||
            Объект.Позиция_Y + Объект.Высота < Объект.Высота ||
            Объект.Позиция_Y > Холст.height - Объект.Высота)
            return true
    }
}

function Объект_Столкновение_С_Другим_Объектом(Первый_Объект, Второй_Объект) {

    Первый_Объект.Столкнулся_С_Объектом = true
    Второй_Объект.Столкнулся_С_Объектом = true

    if (Второй_Объект.Твердое_Тело) {
        Первый_Объект.Позиция_X -= Первый_Объект.Скорость_По_X * Интервал_Времени
        Первый_Объект.Позиция_Y -= Первый_Объект.Скорость_По_Y * Интервал_Времени
    } else {
        return true
    }
    return false
}

function Объект_Управление(
    Режим,
    Объект,
    Скорость,
    Движение,
    Платформа,
    Гравитация,
    Высота_Прыжка
) {

    switch (Режим) {

        case "Вид_Сверху":
            if (Движение.Влево) {
                Объект.Скорость_По_X = -Скорость
            } else
                Объект.Скорость_По_X = 0
            if (Движение.Вправо) {
                Объект.Скорость_По_X = Скорость
            }
            if (Движение.Вверх) {
                Объект.Скорость_По_Y = -Скорость
            } else
                Объект.Скорость_По_Y = 0
            if (Движение.Вниз) {
                Объект.Скорость_По_Y = Скорость
            }
            break

        case "Платформа":

            if (Движение.Влево) {
                Объект.Скорость_По_X = -Скорость
            } else
                Объект.Скорость_По_X = 0
            if (Движение.Вправо) {
                Объект.Скорость_По_X = Скорость
            }
            if (Движение.Вверх) {
                if (Объект.Находиться_На_Земле) {
                    Объект.Скорость_По_Y = Высота_Прыжка
                    Объект.Находиться_На_Земле = false
                }
            }

            // console.log(Объект.Скорость_По_Y  );
            // if (Объект.Коллайдер.Позиция_Y + Объект.Коллайдер.Высота <= Платформа.Позиция_Y
            //     && Объект.Коллайдер.Позиция_Y + Объект.Коллайдер.Высота + Объект.Скорость_По_Y    >= Платформа.Позиция_Y
            //     && Объект.Коллайдер.Позиция_X + Объект.Коллайдер.Ширина >= Платформа.Позиция_X
            //     && Объект.Коллайдер.Позиция_X <= Платформа.Позиция_X + Платформа.Ширина) {
            if (Объект.Коллайдер.Позиция_Y + Объект.Коллайдер.Высота >= Платформа.Позиция_Y &&
                Объект.Коллайдер.Позиция_Y <= Платформа.Позиция_Y + Платформа.Высота &&
                Объект.Коллайдер.Позиция_X <= Платформа.Позиция_X + Платформа.Ширина &&
                Объект.Коллайдер.Позиция_X + Объект.Коллайдер.Ширина >= Платформа.Позиция_X
            ) {

                if (Объект.Скорость_По_Y > 0) {
                    Объект.Скорость_По_Y = 0
                    Объект.Позиция_Y = Платформа.Позиция_Y - Объект.Коллайдер.Высота
                    Объект.Находиться_На_Земле = true
                    break
                }

            } else {
                Объект.Находиться_На_Земле = false
            }
            if (Объект.Коллайдер.Позиция_Y + Объект.Коллайдер.Высота + Объект.Скорость_По_Y <= Платформа.Высота) {
                Объект.Скорость_По_Y += Гравитация
            }

            break
    }
}

function Значение_Получить_Случайное(Минимально_Значение, Максимальное_Значение) {
    return Math.random() * (Максимальное_Значение - Минимально_Значение) + Минимально_Значение
}

function Объект_Добавить_Изменить_Свойство(Объект, Свойство, Значение) {
    return Reflect.set(Объект, Свойство, Значение)
}

function Объект_Получить_Свойство(Объект, Свойство) {
    return Reflect.get(Объект, Свойство)
}

function Линейная_Интерполяция(Начало, Конец, Время) {
    return Начало * (1 - Время) + Конец * Время
}

function Объект_Плавное_Передвижение_К_Точке(Объект, Мышь, Время = 0.2) {

    let Позиция_X = Линейная_Интерполяция(Объект.Позиция_X, Мышь.Позиция_X, Время)
    let Позиция_Y = Линейная_Интерполяция(Объект.Позиция_Y, Мышь.Позиция_Y, Время)

    Объект.Скорость_По_X -= (Объект.Позиция_X - Позиция_X) * Интервал_Времени
    Объект.Скорость_По_Y -= (Объект.Позиция_Y - Позиция_Y) * Интервал_Времени
}

function Элемент_В_Массиве_Получить_Случайный(Массив) {
    if (Массив.length > 0) {
        return Массив[Math.round(Math.random() * (Массив.length - 1))]
    }
}

function Корутина(Функция) {
    var Экземпляр_Корутины = Функция()
    Экземпляр_Корутины.next()
    return function (Элемент) {
        Экземпляр_Корутины.next(Элемент)
    }
}

var Копировать_Объект = (Объект) => {
    const Объект_Клон = {}
    for (let Свойство in Объект) {
        if (Объект.hasOwnProperty(Свойство)) {
            if (typeof Объект[Свойство] === 'object') {
                Объект_Клон[Свойство] = Копировать_Объект(Объект[Свойство])
            }
            else {
                Объект_Клон[Свойство] = Объект[Свойство]
            }
        }
    }
   
    return Объект_Клон
}

function Синус_Угла_В_Радианах(Значение) {
    let Результат = Math.sin(Значение * Math.PI / 180)
    return Результат
}

function Косинус_Угла_В_Радианах(Значение) {
    let Результат = Math.cos(Значение * Math.PI / 180)
    return Результат
}

function Найти_Случайную_Точку_На_Окружности(Окружность) {

    let Радиус = Окружность.Радиус * Math.sqrt(Math.random())

    let Угловое_Положение_Вектора = Math.random() * 2 * Math.PI
    let Позиция_X = Окружность.Позиция_X - Радиус * Math.cos(Угловое_Положение_Вектора)
    let Позиция_Y = Окружность.Позиция_Y - Радиус * Math.sin(Угловое_Положение_Вектора)

    return { Позиция_X: Позиция_X, Позиция_Y: Позиция_Y }

}

function Массив_Перемешать(Массив) {
    Массив.sort(() => Math.random() - 0.5)
}

// function Кнопка_Создать({ Позиция_X, Позиция_Y, Ширина, Высота }) {
    
//     this.Позиция_X = Позиция_X
//     this.Позиция_Y = Позиция_Y
//     this.Ширина = Ширина
//     this.Высота = Высота

//     let Кнопка = new Path2D
//     Кнопка.rect(this.Позиция_X, this.Позиция_Y, this.Ширина, this.Высота)
//     return Кнопка
// }

var Начать_Игру_Кнопка
var Игра_Состояние = "Меню"
var Название_Игры

function Начальное_Меню() {

    Начать_Игру_Кнопка = {

        Кнопка: new Квадрат({
            Позиция_X: Холст.width / 2 - 200,
            Позиция_Y: 500,
            Высота: 100,
            Ширина: 400,
            Цвет: "rgba(0,0,0,0)"
        }).Кнопка_Добавить(),

        Текст: new Текст({
            Позиция_X: Холст.width / 2,
            Позиция_Y: 585,
            Текст: " ИГРАТЬ ",
            Выравнивание_По: "center",
            Размер_Шрифта: 100,
            Цвет: "white",
            Тень: true,
            Название_Шрифта: "Russo One",
            Цвет_Тени: "#594375",
            Смещение_Тени_По_X: 4,
            Смещение_Тени_По_Y: 2
        }).Обновить(),
    }
}

var Меню = new Спрайт({ Путь_К_Файлу: "assets/menu" })


function Меню_Окно_Обновить(Событие) {

    if (Игра_Состояние == "Меню") {
        Меню.Картинка.width = Холст.width
        Меню.Картинка.height = Холст.height
        Меню.Обновить()
        Начать_Игру_Кнопка.Кнопка.Обновить()
        Начать_Игру_Кнопка.Текст.Обновить()

        if (Контекст.isPointInPath(Начать_Игру_Кнопка.Кнопка.Кнопка, Событие.offsetX, Событие.offsetY)) {
            window.requestAnimationFrame(Кадр_Обновить)
            Запуск_Уровня(Уровень)
            Игра_Состояние = "Игра"
        }
    }

    requestAnimationFrame(Меню_Окно_Обновить)
}

window.addEventListener("load", function(){
    Начальное_Меню()
   
    requestAnimationFrame(Меню_Окно_Обновить)
    addEventListener("click", Меню_Окно_Обновить)
})


var Кнопка_Перезапустить_Уровень
var Кнопка_Следующий_Уровень

let Проигрыш_Текст
let Окно_Проигрыша
let Текст_Перезапустить_Уровень
function Игра_Проиграна() {

    Окно_Проигрыша = new Спрайт({ Позиция_X: 0, Позиция_Y: 0, Путь_К_Файлу: "assets/lose_window" })
    Окно_Проигрыша.Картинка.width = Холст.width
    Окно_Проигрыша.Картинка.height = Холст.height

    Проигрыш_Текст = new Текст({
        Текст: "Поражение",
        Позиция_X: Холст.width / 2,
        Позиция_Y: Холст.height / 2 - 200,
        Выравнивание_По: "center",
        Размер_Шрифта: 80,
        Цвет: "white",
        Тень: true,
        Название_Шрифта: "Russo One",
        Цвет_Тени: "purple",
        Смещение_Тени_По_X: 4,
        Смещение_Тени_По_Y: 2
    })

    Кнопка_Перезапустить_Уровень = new Квадрат({ Позиция_X: Холст.width / 2 - 200, Позиция_Y: Холст.height / 2 + 100, Ширина: 600, Высота: 100, Цвет: `rgba(255,255,255,1)` }).Кнопка_Добавить().Обновить()

    Текст_Перезапустить_Уровень = new Текст({
        Позиция_X: Кнопка_Перезапустить_Уровень.Центр_Объекта.Позиция_X - 100,
        Позиция_Y: Кнопка_Перезапустить_Уровень.Центр_Объекта.Позиция_Y,
        Текст: "Перезапустить уровень",
        Выравнивание_По: "center",
        Размер_Шрифта: 50,
        Цвет: "white",
        Название_Шрифта: "Russo One",
        Цвет_Тени: "purple",
        Смещение_Тени_По_X: 4,
        Смещение_Тени_По_Y: 2
    }).Обновить()

    Игра_Состояние = "Проигрыш"
}

function Сброс_Данных() {
    Место_Постройки = []
    Позиции = []
    Башни_Купленные = []
    Враги = []
    Массив_Эффекта_Уничтожения_Противника = []
    clearInterval(Создание_Врагов)
}

function Перезапустить_Уровень(Событие) {

    if (Игра_Состояние == "Проигрыш") {

        if (Контекст.isPointInPath(Кнопка_Перезапустить_Уровень.Кнопка, Событие.offsetX, Событие.offsetY)) {
            Сброс_Данных()
            Запуск_Уровня(Уровень)
            Игра_Состояние = "Игра"
        }
    }
}

let Окно_Победы
let Победа_Текст
let Текст_Следующий_Уровень
function Игра_Окончена() {

    Игра_Состояние = "Победа"

    Окно_Победы = new Спрайт({ Позиция_X: 0, Позиция_Y: 0, Путь_К_Файлу: "assets/winner_window", })
    Окно_Победы.Картинка.width = Холст.width
    Окно_Победы.Картинка.height = Холст.height
    Победа_Текст = new Текст({
        Текст: "Победа!!!",
        Позиция_X: Холст.width / 2,
        Позиция_Y: Холст.height / 2 - 300,
        Выравнивание_По: "center",
        Размер_Шрифта: 80,
        Цвет: "white",
        Тень: true,
        Название_Шрифта: "Russo One",
        Цвет_Тени: "purple",
        Смещение_Тени_По_X: 4,
        Смещение_Тени_По_Y: 2
    })

    Кнопка_Следующий_Уровень = new Квадрат({ Позиция_X: Холст.width / 2 - 200, Позиция_Y: Холст.height / 2 + 100, Ширина: 600, Высота: 100, Цвет: `rgba(255,255,255,1)` }).Кнопка_Добавить().Обновить()

    Текст_Следующий_Уровень = new Текст({
        Позиция_X: Кнопка_Следующий_Уровень.Центр_Объекта.Позиция_X - 100,
        Позиция_Y: Кнопка_Следующий_Уровень.Центр_Объекта.Позиция_Y,
        Текст: "Следующий уровень",
        Выравнивание_По: "center",
        Размер_Шрифта: 50,
        Цвет: "white",
        Название_Шрифта: "Russo One",
        Цвет_Тени: "purple",
        Смещение_Тени_По_X: 4,
        Смещение_Тени_По_Y: 2
    })
}

function Окно_Обновление_При_Разных_Состояний() {


    if (Игра_Состояние == "Победа") {

        Окно_Победы.Обновить()
        Победа_Текст.Обновить()
        if (Уровень < 2)
            Текст_Следующий_Уровень.Обновить()
    }
    if (Игра_Состояние == "Проигрыш") {

        Окно_Проигрыша.Обновить()
        Проигрыш_Текст.Обновить()
        Текст_Перезапустить_Уровень.Обновить()
    }

    window.requestAnimationFrame(Окно_Обновление_При_Разных_Состояний)
}

window.requestAnimationFrame(Окно_Обновление_При_Разных_Состояний)

function Следущий_Уровень(Событие) {
    if (Игра_Состояние == "Победа") {

        if (Контекст.isPointInPath(Кнопка_Следующий_Уровень.Кнопка, Событие.offsetX, Событие.offsetY)) {
            Сброс_Данных()
            Уровень++
            Запуск_Уровня(Уровень)
            Игра_Состояние = "Игра"
        }
    }
}

var Уровень = 1

var Карты = [new Спрайт({ Позиция_X: 0, Позиция_Y: -50, Путь_К_Файлу: "assets/map_lvl1" }), new Спрайт({ Позиция_X: 0, Позиция_Y: -50, Путь_К_Файлу: "assets/map_lvl2" })]
var Карта

var Позиции = []

var База = {}

var Место_Постройки = []

function Запуск_Уровня(Уровень) {

    Карта = Карты[Уровень - 1]
    База.Здоровье = 10
    Деньги.Начальное_Количество_Применить(3000)
    for (let i = 0; i < Место_Постройки_Позиции[Уровень - 1].length; i++) {
        Место_Постройки.push(new Место_Для_Постройки(Место_Постройки_Позиции[Уровень - 1][i].Позиция_X,
            Место_Постройки_Позиции[Уровень - 1][i].Позиция_Y))
    }

    for (let i = 0; i < Координаты_Пути[Уровень - 1].length; i++) {
        Позиции.push(new Круг({
            Позиция_X: Координаты_Пути[Уровень - 1][i].Позиция_X,
            Позиция_Y: Координаты_Пути[Уровень - 1][i].Позиция_Y,
            Радиус: 5,
            Цвет: "rgba(0,0,0,0)"
        }))
    }

    Игра_Начать()
}

var Координаты_Пути = [[
    {
        Позиция_X: -50,
        Позиция_Y: 110
    },
    {
        Позиция_X: 670,
        Позиция_Y: 110
    },
    {
        Позиция_X: 670,
        Позиция_Y: 620
    },
    {
        Позиция_X: 290,
        Позиция_Y: 620
    },
    {
        Позиция_X: 290,
        Позиция_Y: 880
    },
    {
        Позиция_X: 990,
        Позиция_Y: 880
    },
    {
        Позиция_X: 990,
        Позиция_Y: 150
    },
    {
        Позиция_X: 1540,
        Позиция_Y: 150
    },
    {
        Позиция_X: 1540,
        Позиция_Y: 880
    },
    {
        Позиция_X: 3000,
        Позиция_Y: 880
    },],
[
    {
        Позиция_X: -50,
        Позиция_Y: 680
    },
    {
        Позиция_X: 380,
        Позиция_Y: 680
    },
    {
        Позиция_X: 380,
        Позиция_Y: 240
    },
    {
        Позиция_X: 670,
        Позиция_Y: 240
    },
    {
        Позиция_X: 670,
        Позиция_Y: 650
    },
    {
        Позиция_X: 990,
        Позиция_Y: 650
    },
    {
        Позиция_X: 990,
        Позиция_Y: 180
    },
    {
        Позиция_X: 1280,
        Позиция_Y: 180
    },
    {
        Позиция_X: 1280,
        Позиция_Y: 780
    },
    {
        Позиция_X: 1700,
        Позиция_Y: 780
    },
    {
        Позиция_X: 1700,
        Позиция_Y: 500
    },
    {
        Позиция_X: 3000,
        Позиция_Y: 500
    },]
]

class Singleton {
    #Количество
    constructor(Количество) {
        this.#Количество = Количество
    }
    get Количество() {
        return this.#Количество
    }
    Изменить_Количество(Значение) {
        this.#Количество = this.#Количество + Значение
    }
    Начальное_Количество_Применить(Количество) {
        this.#Количество = Количество
    }
}

const Деньги = new Singleton(3000)
Object.freeze(Деньги)

function Враг_Создать({ Атлас, Здоровье }) {
    this.Атлас = Атлас
    this.Максимальное_Здоровье = Здоровье
    this.Здоровье = Здоровье
    this.Коллайдер = this.Атлас.Коллайдер
    this.Состояние = ""

    this.Урон_Получить = function (Урон) {
        this.Здоровье -= Урон
    }

    this.Изменить_Состояние = function () {
        this.Состояние = "Идти"
        this.Начальная_Позиция_X = Math.floor(this.Атлас.Позиция_X)
        this.Начальная_Позиция_Y = Math.floor(this.Атлас.Позиция_Y)
    }

    this.Здоровье_Отобразить = function () {
        Контекст.strokeStyle = '#333'
        Контекст.lineWidth = 2

        Контекст.strokeRect(
            this.Атлас.Позиция_X,
            this.Атлас.Позиция_Y - 20,
            this.Атлас.Ширина,
            10
        )

        Контекст.fillStyle = this.Здоровье > (this.Максимальное_Здоровье / 100 * 40) ? '#0ed00e' : 'red'
        Контекст.fillRect(
            this.Атлас.Позиция_X,
            this.Атлас.Позиция_Y - 20,
            this.Атлас.Ширина * (this.Здоровье / this.Максимальное_Здоровье),
            10
        )
        Контекст.closePath()
    }

    this.Перемещение_По_Точкам = function (Точки_Пути) {

        let Точка_Пути = Точки_Пути[this.Атлас.Индекс_Точки_Пути]
        let Дистанция_До_Точки_X = Точка_Пути.Позиция_X - this.Атлас.Центр_Объекта.Позиция_X
        let Дистанция_До_Точки_Y = Точка_Пути.Позиция_Y - this.Атлас.Центр_Объекта.Позиция_Y
        let Угол_В_Радианах = Math.atan2(Дистанция_До_Точки_Y, Дистанция_До_Точки_X)

        this.Атлас.Позиция_X += Math.cos(Угол_В_Радианах)
        this.Атлас.Позиция_Y += Math.sin(Угол_В_Радианах)
        this.Атлас.Центр_Объекта = {
            Позиция_X: this.Атлас.Позиция_X + this.Атлас.Ширина / 2,
            Позиция_Y: this.Атлас.Позиция_Y + this.Атлас.Высота / 2
        }

        if (Math.round(this.Атлас.Центр_Объекта.Позиция_X) === Math.round(Точка_Пути.Позиция_X) &&
            Math.round(this.Атлас.Центр_Объекта.Позиция_Y) === Math.round(Точка_Пути.Позиция_Y) &&
            this.Атлас.Индекс_Точки_Пути < Точки_Пути.length - 1) {
            this.Атлас.Индекс_Точки_Пути++
            this.Повернуть(Точки_Пути)
        }
        this.Коллайдер.Позиция_X = this.Атлас.Позиция_X
        this.Коллайдер.Позиция_Y = this.Атлас.Позиция_Y
    }

    this.Обновить = function (Точки_Пути) {
        if (this.Состояние == "Идти") {
            this.Перемещение_По_Точкам(Точки_Пути)
            this.Атлас.Обновить()
            this.Здоровье_Отобразить()
            // this.Спрайт.Коллайдер_Показать()
        }
    }

    this.Повернуть = function (Точки_Пути) {

        if (Точки_Пути[this.Атлас.Индекс_Точки_Пути].Позиция_X > Точки_Пути[this.Атлас.Индекс_Точки_Пути - 1].Позиция_X) {
            this.Сменить_Спрайт("Вправо")
            return
        }
        if (Точки_Пути[this.Атлас.Индекс_Точки_Пути].Позиция_X < Точки_Пути[this.Атлас.Индекс_Точки_Пути - 1].Позиция_X) {
            this.Сменить_Спрайт("Влево")
            return
        }
        if (Точки_Пути[this.Атлас.Индекс_Точки_Пути].Позиция_Y > Точки_Пути[this.Атлас.Индекс_Точки_Пути - 1].Позиция_Y) {
            this.Сменить_Спрайт("Вниз")
            return
        }
        if (Точки_Пути[this.Атлас.Индекс_Точки_Пути].Позиция_Y < Точки_Пути[this.Атлас.Индекс_Точки_Пути - 1].Позиция_Y) {
            this.Сменить_Спрайт("Вверх")
            return
        }
    }
    this.Сменить_Спрайт = function (Направление) {
        this.Атлас.Установить_Анимацию(Направление)
    }
}

var Количество_Созданных_Врагов = 0

var Фабрика = function () {

    this.Создать_Врага = function (Враг_Тип) {
        let Враг
        Количество_Созданных_Врагов++

        switch (Враг_Тип) {
            case "Гусеница":
                Враг = new Враг_Создать({
                    Атлас: new Атлас({
                        Позиция_X: Позиции[0].Позиция_X - 25,
                        Позиция_Y: Позиции[0].Позиция_Y - 25,
                        Путь_К_Файлу: "assets/green_enemy_right",
                        Максимум_Кадров: 8,
                        Скорость_Смены_Кадра: 4,
                        Спрайты: {
                            Влево: {
                                Путь_К_Файлу: 'assets/green_enemy_left',
                                Максимум_Кадров: 8
                            },
                            Вправо: {
                                Путь_К_Файлу: 'assets/green_enemy_right',
                                Максимум_Кадров: 8
                            },
                            Вверх: {
                                Путь_К_Файлу: 'assets/green_enemy_up',
                                Максимум_Кадров: 8
                            },
                            Вниз: {
                                Путь_К_Файлу: 'assets/green_enemy_down',
                                Максимум_Кадров: 8
                            }
                        }
                    }).Коллайдер_Добавить(),
                    Здоровье: 150,
                })
                break

            case "Скорпион":
                Враг = new Враг_Создать({
                    Атлас: new Атлас({
                        Позиция_X: Позиции[0].Позиция_X - 25,
                        Позиция_Y: Позиции[0].Позиция_Y - 25,
                        Путь_К_Файлу: "assets/scorp_enemy_right",
                        Максимум_Кадров: 8,
                        Скорость_Смены_Кадра: 4,
                        Спрайты: {
                            Влево: {
                                Путь_К_Файлу: 'assets/scorp_enemy_left',
                                Максимум_Кадров: 8
                            },
                            Вправо: {
                                Путь_К_Файлу: 'assets/scorp_enemy_right',
                                Максимум_Кадров: 8
                            },
                            Вверх: {
                                Путь_К_Файлу: 'assets/scorp_enemy_up',
                                Максимум_Кадров: 8
                            },
                            Вниз: {
                                Путь_К_Файлу: 'assets/scorp_enemy_down',
                                Максимум_Кадров: 8
                            }
                        }
                    }).Коллайдер_Добавить(),
                    Здоровье: 300,
                })
                break

            case "Скорпион_Магма":
                Враг = new Враг_Создать({
                    Атлас: new Атлас({
                        Позиция_X: Позиции[0].Позиция_X - 25,
                        Позиция_Y: Позиции[0].Позиция_Y - 25,
                        Путь_К_Файлу: "assets/magma_scorp_enemy_right",
                        Максимум_Кадров: 8,
                        Скорость_Смены_Кадра: 4,
                        Спрайты: {
                            Влево: {
                                Путь_К_Файлу: 'assets/magma_scorp_enemy_left',
                                Максимум_Кадров: 8
                            },
                            Вправо: {
                                Путь_К_Файлу: 'assets/magma_scorp_enemy_right',
                                Максимум_Кадров: 8
                            },
                            Вверх: {
                                Путь_К_Файлу: 'assets/magma_scorp_enemy_up',
                                Максимум_Кадров: 8
                            },
                            Вниз: {
                                Путь_К_Файлу: 'assets/magma_scorp_enemy_down',
                                Максимум_Кадров: 8
                            }
                        }
                    }).Коллайдер_Добавить(),
                    Здоровье: 500,
                })
                break
        }
        return Враг
    }
}

var Враги_Фабрика = new Фабрика()
var Враги = []

class Башня extends Объект {
    constructor({
        Позиция_X,
        Позиция_Y,
        Путь_К_Файлу,
        Урон,
        Скорость_Стрельбы,
        Радиус_Атаки,
        Имя_Башни,
        Цена,
        Цвет_Стрельбы,
        Стоимость_Улучшения
    }) {
        super({ Позиция_X, Позиция_Y })

        this.Путь_К_Файлу = Путь_К_Файлу
        this.Спрайт = new Спрайт({
            Позиция_X: this.Позиция_X,
            Позиция_Y: this.Позиция_Y,
            Путь_К_Файлу: this.Путь_К_Файлу,
            Масштаб: 1
        })
        this.Ширина = this.Спрайт.Ширина
        this.Высота = this.Спрайт.Высота
        this.Урон = Урон
        this.Скорость_Стрельбы = Скорость_Стрельбы
        this.Радиус_Атаки = Радиус_Атаки
        this.Имя_Башни = Имя_Башни
        this.Цена = Цена
        this.Зона_Атаки = new Круг({
            Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
            Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
            Радиус: this.Радиус_Атаки,
            Цвет: "rgba(255,255,255,0)"
        }).Коллайдер_Добавить()

        switch (this.Имя_Башни) {
            case "Магическая":
                this.Оружие_Башни_Уровень_1 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/magic_tower_lvl1_weapon",
                    Максимум_Кадров: 10,
                    Скорость_Смены_Кадра: 5,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl1_weapon',
                            Максимум_Кадров: 10
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl1_weapon_attack',
                            Максимум_Кадров: 16
                        }
                    }
                })
                this.Оружие_Башни_Уровень_2 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/magic_tower_lvl2_weapon",
                    Максимум_Кадров: 16,
                    Скорость_Смены_Кадра: 5,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl2_weapon',
                            Максимум_Кадров: 16
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl2_weapon_attack',
                            Максимум_Кадров: 17
                        }
                    }
                })
                this.Оружие_Башни_Уровень_3 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/magic_tower_lvl3_weapon",
                    Максимум_Кадров: 20,
                    Скорость_Смены_Кадра: 5,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl3_weapon',
                            Максимум_Кадров: 20
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/magic_tower_lvl3_weapon_attack',
                            Максимум_Кадров: 19
                        }
                    }
                })
                break
            case "Электрическая":
                this.Оружие_Башни_Уровень_1 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/electric_tower_lvl1_weapon",
                    Максимум_Кадров: 3,
                    Скорость_Смены_Кадра: 6,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl1_weapon',
                            Максимум_Кадров: 3
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl1_weapon_attack',
                            Максимум_Кадров: 10
                        }
                    }
                })
                this.Оружие_Башни_Уровень_2 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/electric_tower_lvl2_weapon",
                    Максимум_Кадров: 3,
                    Скорость_Смены_Кадра: 6,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl2_weapon',
                            Максимум_Кадров: 3
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl2_weapon_attack',
                            Максимум_Кадров: 10
                        }
                    }
                })
                this.Оружие_Башни_Уровень_3 = new Атлас({
                    Позиция_X: this.Позиция_X + this.Спрайт.Ширина / 2,
                    Позиция_Y: this.Позиция_Y + this.Спрайт.Высота / 2,
                    Путь_К_Файлу: "assets/electric_tower_lvl3_weapon",
                    Максимум_Кадров: 3,
                    Скорость_Смены_Кадра: 6,
                    Спрайты: {
                        Ожидание: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl3_weapon',
                            Максимум_Кадров: 3
                        },
                        Атака: {
                            Путь_К_Файлу: 'assets/electric_tower_lvl3_weapon_attack',
                            Максимум_Кадров: 10
                        }
                    }
                })
                break
        }

        this.Оружие_Башни = this.Оружие_Башни_Уровень_1
        this.Цена_Улучшения = 100
        this.Скорость_Стрельбы_Улучшенная = this.Скорость_Стрельбы
        this.Цвет_Стрельбы = Цвет_Стрельбы
        this.Уровень = 1
        this.Стоимость_Улучшения = Стоимость_Улучшения
        this.Панель_Улучшения = {
            Кнопка_Улучшения: new Спрайт({ Путь_К_Файлу: "assets/blue_button12" }).Кнопка_Добавить(),
            Кнопка_Улучшения_Состояние: "Доступно",
            Кнопка_Продажи: new Спрайт({ Путь_К_Файлу: "assets/red_button12" }).Кнопка_Добавить(),
            Состояние: "Закрыт"
        }
    }

    Получить_Цель_Атаки() {

        let Цель_Атаки
        if (!Цель_Атаки) {
            for (let i = 0; i < Враги.length; i++) {
                if ((Враги[i].Состояние == "Идти") &&
                    (Столкновение_Определить(this.Зона_Атаки, Враги[i]))) {
                    Цель_Атаки = Враги[i]
                    break
                }
            }
        }

        if (Цель_Атаки) {
            this.Враг_В_Зоне_Поражения = Цель_Атаки
            this.Оружие_Башни.Установить_Анимацию("Атака")
            this.Спрайт.Отрисовать()
        } else {
            this.Оружие_Башни.Установить_Анимацию("Ожидание")
            this.Спрайт.Отрисовать()
            this.Враг_В_Зоне_Поражения = ""
        }
    }

    Атака() {
        if (this.Враг_В_Зоне_Поражения) {
            if (this.Оружие_Башни.Текущий_Кадр >= 5 && this.Оружие_Башни.Текущий_Кадр <= 12) {
                let Угол_Направления_Объекта = Math.atan2((this.Враг_В_Зоне_Поражения.Атлас.Позиция_Y +
                    this.Враг_В_Зоне_Поражения.Атлас.Высота / 2) -
                    (this.Позиция_Y + this.Высота / 2),
                    (this.Враг_В_Зоне_Поражения.Атлас.Позиция_X + this.Враг_В_Зоне_Поражения.Атлас.Ширина / 2) -
                    (this.Позиция_X + this.Ширина / 2))
                let Направление_Атаки = {
                    По_X: Math.cos(Угол_Направления_Объекта),
                    По_Y: Math.sin(Угол_Направления_Объекта)
                }

                Линия_Создать({
                    Начало_Линии_Позиция_X: this.Оружие_Башни.Позиция_X + this.Оружие_Башни.Ширина / 2 + Направление_Атаки.По_X,
                    Начало_Линии_Позиция_Y: this.Оружие_Башни.Позиция_Y + this.Оружие_Башни.Высота / 2 + Направление_Атаки.По_Y - 10,
                    Конец_Линии_Позиция_X: this.Враг_В_Зоне_Поражения.Атлас.Позиция_X + this.Враг_В_Зоне_Поражения.Атлас.Ширина / 2,
                    Конец_Линии_Позиция_Y: this.Враг_В_Зоне_Поражения.Атлас.Позиция_Y + this.Враг_В_Зоне_Поражения.Атлас.Высота / 2,
                    Цвет: this.Цвет_Стрельбы,
                    Толщина_Линии: 7,
                    Закруглить_Концы_Линии: true,
                    Прозрачность: 0.8
                })

                this.Враг_В_Зоне_Поражения.Урон_Получить(this.Урон / 100)
                this.Скорость_Стрельбы = this.Скорость_Стрельбы_Улучшенная
            }
        }
    }

    Показать_Зону_Атаки() {
        this.Зона_Атаки.Позиция_X = this.Позиция_X + this.Спрайт.Ширина / 2
        this.Зона_Атаки.Позиция_Y = this.Позиция_Y + this.Спрайт.Высота / 2
        this.Оружие_Башни.Позиция_X = this.Спрайт.Позиция_X + this.Спрайт.Ширина / 2 - this.Оружие_Башни.Ширина / 2
        this.Оружие_Башни.Позиция_Y = this.Спрайт.Позиция_Y + this.Спрайт.Высота / 2 - this.Оружие_Башни.Высота / 2

        this.Зона_Атаки.Отрисовать()
        this.Спрайт.Позиция_X = this.Позиция_X
        this.Спрайт.Позиция_Y = this.Позиция_Y
    }

    Улучшить() {

        if ((Деньги.Количество < this.Стоимость_Улучшения) || (this.Уровень > 2))
            return

        Деньги.Изменить_Количество(- this.Стоимость_Улучшения)

        this.Уровень++

        switch (this.Уровень) {
            case 2:
                this.Урон += 20
                this.Скорость_Стрельбы_Улучшенная += 2
                this.Стоимость_Улучшения += 150
                this.Спрайт.Путь_К_Файлу = "assets/magic_tower_lvl2"
                if (this.Имя_Башни == "Электрическая") {
                    this.Спрайт.Путь_К_Файлу = "assets/electric_tower_lvl2"
                    this.Цвет_Стрельбы = "#7f00ff"
                } else
                    this.Цвет_Стрельбы = "#f2a100"

                this.Позиция_Y -= 10
                this.Оружие_Башни = this.Оружие_Башни_Уровень_2
                break

            case 3:
                this.Урон += 20
                this.Скорость_Стрельбы_Улучшенная += 2
                this.Стоимость_Улучшения += 150
                this.Панель_Улучшения.Кнопка_Улучшения_Состояние = "Недоступно"
                this.Спрайт.Путь_К_Файлу = "assets/magic_tower_lvl3"
                if (this.Имя_Башни == "Электрическая") {
                    this.Спрайт.Путь_К_Файлу = "assets/electric_tower_lvl3"
                    this.Цвет_Стрельбы = "#c00"
                } else
                    this.Цвет_Стрельбы = "#78d400"

                this.Оружие_Башни = this.Оружие_Башни_Уровень_3
                this.Позиция_Y -= 10
                break
        }
    }

    Панель_Улучшения_Открыть() {
        this.Панель_Улучшения.Состояние = "Открыть"
        this.Панель_Улучшения.Кнопка_Улучшения.Позиция_X = this.Оружие_Башни.Позиция_X + 80
        this.Панель_Улучшения.Кнопка_Улучшения.Позиция_Y = this.Оружие_Башни.Позиция_Y + 5
        this.Панель_Улучшения.Кнопка_Улучшения.Кнопка_Добавить()
        this.Панель_Улучшения.Кнопка_Продажи.Позиция_X = this.Оружие_Башни.Позиция_X - 90
        this.Панель_Улучшения.Кнопка_Продажи.Позиция_Y = this.Оружие_Башни.Позиция_Y + 5
        this.Панель_Улучшения.Кнопка_Продажи.Кнопка_Добавить()
        this.Зона_Атаки.Цвет = "rgba(255, 255, 255, 0.3)"
    }

    Панель_Улучшения_Закрыть() {
        this.Панель_Улучшения.Состояние = "Закрыть"
        this.Зона_Атаки.Цвет = "rgba(255, 255, 255, 0)"
    }

    Обновить() {

        this.Показать_Зону_Атаки()
        this.Получить_Цель_Атаки()
        this.Атака(Интервал_Времени)
        this.Оружие_Башни.Обновить()

        if (this.Панель_Улучшения.Состояние == "Открыть") {

            if (this.Панель_Улучшения.Кнопка_Улучшения_Состояние == "Доступно") {
                this.Панель_Улучшения.Кнопка_Улучшения.Обновить()

                this.Кнопка_Улучшения_Текст = new Текст({
                    Позиция_X: this.Панель_Улучшения.Кнопка_Улучшения.Позиция_X + this.Ширина / 2,
                    Позиция_Y: this.Панель_Улучшения.Кнопка_Улучшения.Позиция_Y + 80,
                    Текст: this.Стоимость_Улучшения,
                    Цвет: Деньги.Количество >= this.Стоимость_Улучшения ? "white" : "red",
                    Тень: true,
                    Название_Шрифта: "Podkova",
                    Смещение_Тени_По_X: 2,
                    Смещение_Тени_По_Y: 2
                }).Обновить()
            }

            this.Панель_Улучшения.Кнопка_Продажи.Обновить()

            this.Уровень_Текст = new Текст({
                Позиция_X: this.Позиция_X + this.Ширина / 2,
                Позиция_Y: this.Позиция_Y - 30,
                Текст: "Уровень: " + this.Уровень,
                Цвет: "white",
                Тень: true,
                Название_Шрифта: "Podkova",
                Смещение_Тени_По_X: 2,
                Смещение_Тени_По_Y: 2
            }).Обновить()

            this.Панель_Улучшения.Кнопка_Продажи_Текст = new Текст({
                Позиция_X: this.Панель_Улучшения.Кнопка_Продажи.Позиция_X + this.Ширина / 2,
                Позиция_Y: this.Панель_Улучшения.Кнопка_Продажи.Позиция_Y + 80,
                Текст: this.Стоимость_Улучшения / 2,
                Цвет: "white",
                Тень: true,
                Название_Шрифта: "Podkova",
                Смещение_Тени_По_X: 2,
                Смещение_Тени_По_Y: 2
            }).Обновить()
        }
    }
}

var Башня_Магическая = new Башня({
    Путь_К_Файлу: "assets/magic_tower_lvl1",
    Урон: 50,
    Скорость_Стрельбы: 10,
    Радиус_Атаки: 200,
    Имя_Башни: "Магическая",
    Цена: 200,
    Цвет_Стрельбы: "#00f2f2",
    Стоимость_Улучшения: 100,
})

var Башня_Электрическая = new Башня({
    Путь_К_Файлу: "assets/electric_tower_lvl1",
    Урон: 50,
    Скорость_Стрельбы: 15,
    Радиус_Атаки: 200,
    Имя_Башни: "Электрическая",
    Цена: 500,
    Цвет_Стрельбы: "blue",
    Стоимость_Улучшения: 100,
})

var Башни = [Башня_Электрическая, Башня_Магическая]

var Место_Построить

var Панель

function Интерфейс_Покупка_Башни_Открыть() {
    for (let i = 0; i < Место_Постройки.length; i++) {
        // console.log(Место_Постройки[i]);
        Место_Построить = Клик_На_Объект(Мышь, Место_Постройки[i])
        if (Место_Построить) {
            if (Место_Построить.Место_Свободно) {
                Место_Построить.Панель_Покупки_Открыть()
                return
            }
        }
    }
}

var Место_Башня

function Интерфейс_Башни() {
    for (let i = 0; i < Башни_Купленные.length; i++) {
        Место_Башня = Клик_На_Объект(Мышь, Башни_Купленные[i])

        if (Место_Башня) {
            Место_Башня.Панель_Улучшения_Открыть()
        } else {
            Башни_Купленные[i].Панель_Улучшения_Закрыть()
        }
    }
    if (!Место_Башня)
        return
}

function Башня_Улучшить(Событие) {
    for (let i = 0; i < Башни_Купленные.length; i++) {
        let Кнопка_Нажата = Контекст.isPointInPath(Башни_Купленные[i].Панель_Улучшения.Кнопка_Улучшения.Кнопка, Событие.offsetX, Событие.offsetY)
        if (Кнопка_Нажата) {
            Башни_Купленные[i].Улучшить()
            return
        }
    }
}

function Башня_Продать(Событие) {

    for (let i = 0; i < Башни_Купленные.length; i++) {
        let Кнопка_Нажата = Контекст.isPointInPath(Башни_Купленные[i].Панель_Улучшения.Кнопка_Продажи.Кнопка, Событие.offsetX, Событие.offsetY)
        if (Кнопка_Нажата) {
            Башни_Купленные[i].Место_Построить.Место_Свободно = true
            Деньги.Изменить_Количество(Башни_Купленные[i].Стоимость_Улучшения / 2)
            Массив_Удалить_Элемент(Башни_Купленные, i)
            return
        }
    }
}

var Башни_Купленные = []

function Поставить_Башню_На_Выбранное_Место(Башня_Имя) {

    for (let i = 0; i < Башни.length; i++) {

        if ((Башня_Имя == Башни[i].Имя_Башни)) {
            Деньги.Изменить_Количество(- Башни[i].Цена)

            Башни_Купленные.push(new Башня(Копировать_Объект(Башни[i])))
            Башни_Купленные[Башни_Купленные.length - 1].Позиция_X = Место_Построить.Позиция_X
            Башни_Купленные[Башни_Купленные.length - 1].Позиция_Y = Место_Построить.Позиция_Y + Место_Построить.Высота - Башни_Купленные[Башни_Купленные.length - 1].Спрайт.Высота
            Башни_Купленные[Башни_Купленные.length - 1].Место_Построить = Место_Построить
            Башни_Купленные[Башни_Купленные.length - 1].Коллайдер_Добавить()
            Башни_Купленные[Башни_Купленные.length - 1].Зона_Атаки.Коллайдер.Позиция_X = Место_Построить.Позиция_X
            Башни_Купленные[Башни_Купленные.length - 1].Зона_Атаки.Коллайдер.Позиция_Y = Место_Построить.Позиция_Y
            Место_Построить.Место_Свободно = false
            return
        }
    }
}

var Волны = [[
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Гусеница"
    }),
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Скорпион"
    }),
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Скорпион_Магма"
    })
],
[
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Гусеница"
    }),
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Скорпион_Магма"
    }), new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Скорпион"
    }),
    new Волна_Активная({
        Количество_Врагов: 2,
        Враг: "Гусеница"
    })
]]

function Волна_Активная({ Количество_Врагов, Враг }) {
    this.Количество_Врагов = Количество_Врагов
    this.Враг = Враг
}

var Место_Постройки_Позиции = [
    [
        {
            Позиция_X: 500,
            Позиция_Y: 250,
        },
        {
            Позиция_X: 500,
            Позиция_Y: 480,
        },
        {
            Позиция_X: 1100,
            Позиция_Y: 220,
        },
        {
            Позиция_X: 1100,
            Позиция_Y: 500,
        },
        {
            Позиция_X: 380,
            Позиция_Y: 715,
        },
        {
            Позиция_X: 825,
            Позиция_Y: 715,
        },
        {
            Позиция_X: 1620,
            Позиция_Y: 450,
        },
        {
            Позиция_X: 1390,
            Позиция_Y: 750,
        },
    ],
    [
        {
            Позиция_X: 230,
            Позиция_Y: 550,
        },
        {
            Позиция_X: 230,
            Позиция_Y: 250,
        },
        {
            Позиция_X: 500,
            Позиция_Y: 90,
        },
        {
            Позиция_X: 500,
            Позиция_Y: 350,
        },
        {
            Позиция_X: 800,
            Позиция_Y: 220,
        },
        {
            Позиция_X: 800,
            Позиция_Y: 500,
        },
        {
            Позиция_X: 800,
            Позиция_Y: 730,
        },
        {
            Позиция_X: 1100,
            Позиция_Y: 280,
        },
        {
            Позиция_X: 1380,
            Позиция_Y: 600,
        },
        {
            Позиция_X: 1550,
            Позиция_Y: 600,
        },
    ]
]

function Место_Для_Постройки(Позиция_X, Позиция_Y) {
    this.Позиция_X = Позиция_X
    this.Позиция_Y = Позиция_Y

    this.Спрайт = new Спрайт({
        Позиция_X: this.Позиция_X,
        Позиция_Y: this.Позиция_Y,
        Путь_К_Файлу: "assets/build_place1"
    }).Коллайдер_Добавить()
   
    this.Ширина = this.Спрайт.Ширина
    this.Высота = this.Спрайт.Высота
    this.Место_Свободно = true
    this.Коллайдер = this.Спрайт.Коллайдер
    
    this.Панель_Покупки_Башен = {
        Панель_Покупки_Состояние: "Закрыт",
        Первая_Пушка: {
            Спрайт: Башня_Магическая.Спрайт.Коллайдер_Добавить(),
            Название: Башня_Магическая.Имя_Башни,
            Коллайдер: Башня_Магическая.Спрайт.Коллайдер,
            Цена: Башня_Магическая.Цена,
        },
        Вторая_Пушка: {
            Спрайт: Башня_Электрическая.Спрайт.Коллайдер_Добавить(),
            Название: Башня_Электрическая.Имя_Башни,
            Коллайдер: Башня_Электрическая.Спрайт.Коллайдер,
            Цена: Башня_Электрическая.Цена,
        }
    }

    this.Панель_Покупки_Открыть = function () {
        this.Панель_Покупки_Состояние = "Открыт"
        this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_X = this.Позиция_X - 100
        this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_Y = this.Позиция_Y
        this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_X = this.Позиция_X + 100
        this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_Y = this.Позиция_Y
        this.Панель_Покупки_Башен.Первая_Пушка.Коллайдер.Позиция_X = this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_X
        this.Панель_Покупки_Башен.Первая_Пушка.Коллайдер.Позиция_Y = this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_Y
        this.Панель_Покупки_Башен.Вторая_Пушка.Коллайдер.Позиция_X = this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_X
        this.Панель_Покупки_Башен.Вторая_Пушка.Коллайдер.Позиция_Y = this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_Y
    }

    this.Панель_Покупки_Закрыть = function () {
        this.Панель_Покупки_Состояние = "Закрыт"
    }

    this.Панель_Покупки_Обновить = function () {
        if (this.Панель_Покупки_Состояние == "Открыт") {

            this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Обновить()
            this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Обновить()

            this.Панель_Покупки_Башен.Первая_Пушка.Цена_Текст = new Текст({
                Текст: this.Панель_Покупки_Башен.Первая_Пушка.Цена,
                Позиция_X: this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_X + this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Ширина / 2,
                Позиция_Y: this.Панель_Покупки_Башен.Первая_Пушка.Спрайт.Позиция_Y + 100,
                Цвет: Деньги.Количество >= this.Панель_Покупки_Башен.Первая_Пушка.Цена ? "white" : "red",
                Тень: true,
                Название_Шрифта: "Podkova",
                Смещение_Тени_По_X: 2,
                Смещение_Тени_По_Y: 2
            }).Обновить()

            this.Панель_Покупки_Башен.Вторая_Пушка.Цена_Текст = new Текст({
                Текст: this.Панель_Покупки_Башен.Вторая_Пушка.Цена,
                Позиция_X: this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_X + this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Ширина / 2,
                Позиция_Y: this.Панель_Покупки_Башен.Вторая_Пушка.Спрайт.Позиция_Y + 100,
                Цвет: Деньги.Количество >= this.Панель_Покупки_Башен.Вторая_Пушка.Цена ? "white" : "red",
                Тень: true,
                Название_Шрифта: "Podkova",
                Смещение_Тени_По_X: 2,
                Смещение_Тени_По_Y: 2
            }).Обновить()

            if (Мышь.Клик) {

                this.Пушка_Выбранная = Клик_На_Объект(Мышь, this.Панель_Покупки_Башен.Первая_Пушка) || Клик_На_Объект(Мышь, this.Панель_Покупки_Башен.Вторая_Пушка)

                if (!this.Пушка_Выбранная) {
                    this.Панель_Покупки_Закрыть()
                    return
                }

                if (Деньги.Количество < this.Пушка_Выбранная.Цена) {
                    this.Панель_Покупки_Закрыть()
                    return
                }

                Поставить_Башню_На_Выбранное_Место(this.Пушка_Выбранная.Название)
                this.Панель_Покупки_Закрыть()
            }
        }
    }

    this.Обновить = function () {
        this.Спрайт.Отрисовать()
        this.Панель_Покупки_Обновить()
    }
}

var Эффект_Ветров = [new Атлас({
    Позиция_X: 400,
    Позиция_Y: 500,
    Путь_К_Файлу: "assets/effect_wind",
    Максимум_Кадров: 14,
    Скорость_Смены_Кадра: 8
}),
new Атлас({
    Позиция_X: 600,
    Позиция_Y: 700,
    Путь_К_Файлу: "assets/effect_wind",
    Максимум_Кадров: 14,
    Скорость_Смены_Кадра: 8
}),
new Атлас({
    Позиция_X: 850,
    Позиция_Y: 200,
    Путь_К_Файлу: "assets/effect_wind",
    Максимум_Кадров: 14,
    Скорость_Смены_Кадра: 8
}),
new Атлас({
    Позиция_X: 1300,
    Позиция_Y: 300,
    Путь_К_Файлу: "assets/effect_wind",
    Максимум_Кадров: 14,
    Скорость_Смены_Кадра: 8
}),
new Атлас({
    Позиция_X: 1300,
    Позиция_Y: 800,
    Путь_К_Файлу: "assets/effect_wind",
    Максимум_Кадров: 14,
    Скорость_Смены_Кадра: 8
}),
]

var Эффект_Падающего_Листка = [
    new Атлас({
        Позиция_X: 150,
        Позиция_Y: 300,
        Путь_К_Файлу: "assets/effect_leavs",
        Максимум_Кадров: 14,
        Скорость_Смены_Кадра: 8
    }),
    new Атлас({
        Позиция_X: 750,
        Позиция_Y: 750,
        Путь_К_Файлу: "assets/effect_leavs",
        Максимум_Кадров: 14,
        Скорость_Смены_Кадра: 8
    }),
    new Атлас({
        Позиция_X: 1180,
        Позиция_Y: 500,
        Путь_К_Файлу: "assets/effect_leavs",
        Максимум_Кадров: 14,
        Скорость_Смены_Кадра: 8
    }),
    new Атлас({
        Позиция_X: 1120,
        Позиция_Y: 750,
        Путь_К_Файлу: "assets/effect_leavs",
        Максимум_Кадров: 14,
        Скорость_Смены_Кадра: 8
    }),
    new Атлас({
        Позиция_X: 1720,
        Позиция_Y: 420,
        Путь_К_Файлу: "assets/effect_leavs",
        Максимум_Кадров: 14,
        Скорость_Смены_Кадра: 8
    }),

]

var Падающий_Листик
var Эффекта_Ветра

function Эффект_Карты_Обновлять_По_Очереди() {
    setInterval(Корутина(function* () {
        while (true) {
            Падающий_Листик = Элемент_В_Массиве_Получить_Случайный(Эффект_Падающего_Листка)
            Эффекта_Ветра = Элемент_В_Массиве_Получить_Случайный(Эффект_Ветров)
            yield
        }
    }), 1700)
}

var Массив_Эффекта_Уничтожения_Противника = []

Холст.width = window.innerWidth
Холст.height = window.innerHeight

window.addEventListener('resize', function () {
    Холст.width = window.innerWidth
    Холст.height = window.innerHeight
})

var Курсор = new Спрайт({ Путь_К_Файлу: "assets/Arrow_Rounded_White" })
Курсор_Изменить_Спрайт(Курсор)

var Спрайт_Для_Интерфейса = new Спрайт({ Позиция_X: 0, Позиция_Y: 0, Путь_К_Файлу: "assets/panel_Example2" })

var Волна_Номер = 0

var Время_Появления_Врагов = 2

var Создание_Врагов

function Враги_Появление() {

    let Счетчик_Появления_Врагов = 0

    let Уровень_Волны = Уровень - 1
    Волны[Уровень_Волны].forEach((Объект) => {

        for (let i = 0; i < Объект.Количество_Врагов; i++) {
            let Враг = Враги_Фабрика.Создать_Врага(Объект.Враг)
            Враги.push(Враг)
        }
    })

    Создание_Врагов = setInterval(Корутина(function* () {

        for (let Активная_Волна in Волны[Уровень_Волны]) {
            let Волна = Волны[Уровень_Волны][Активная_Волна]
            Волна_Номер = Number(Активная_Волна) + 1
            yield

            for (let i = 0; i < Волна.Количество_Врагов; i++) {
                yield
                Враги[Счетчик_Появления_Врагов].Изменить_Состояние()
                Счетчик_Появления_Врагов++
            }
            yield
        }
    }), Время_Появления_Врагов * 1000)
}

function Интерфейс_Игры() {

    Спрайт_Для_Интерфейса.Обновить()
    Спрайт_Для_Интерфейса.Картинка.width = window.innerWidth
    Спрайт_Для_Интерфейса.Картинка.height = 50

    let Здоровье_Базы_Текст = new Текст({
        Текст: "Здоровье Базы: " + База.Здоровье,
        Позиция_X: Холст.width / 2,
        Позиция_Y: 30,
        Цвет: "white",
        Выравнивание_По: "center",
        Название_Шрифта: "Podkova",
        Тень: true, Цвет_Тени: "0024a8",
        Смещение_Тени_По_X: 2,
        Смещение_Тени_По_Y: 2
    }).Обновить()
    let Деньги_Текст = new Текст({
        Текст: "Деньги: " + Деньги.Количество,
        Позиция_X: (Холст.width / 2) - 400,
        Позиция_Y: 30,
        Цвет: "white",
        Выравнивание_По: "center",
        Название_Шрифта: "Podkova",
        Тень: true,
        Цвет_Тени: "#0024a8",
        Смещение_Тени_По_X: 2,
        Смещение_Тени_По_Y: 2
    }).Обновить()
    let Волна_Текст = new Текст({
        Текст: "Волна: " + `${Волна_Номер} / ${Волны[Уровень - 1].length}`,
        Позиция_X: (Холст.width / 2) + 400,
        Позиция_Y: 30,
        Цвет: "white",
        Выравнивание_По: "center",
        Название_Шрифта: "Podkova",
        Тень: true,
        Цвет_Тени: "#0024a8",
        Смещение_Тени_По_X: 2,
        Смещение_Тени_По_Y: 2
    }).Обновить()
}

function Массивы_Обновить(Интервал_Времени) {

    Объекты_В_Массиве_Обновить(Позиции)

    for (let i = 0; i < Враги.length; i++) {
        if (Враги[i].Состояние == "Идти") {
            Враги[i].Обновить(Позиции)

            if (Враги[i].Здоровье <= 0) {
                for (let j = 0; j < 30; j++) {
                    Массив_Эффекта_Уничтожения_Противника.push(new Круг({ Позиция_X: Враги[i].Атлас.Центр_Объекта.Позиция_X, Позиция_Y: Враги[i].Атлас.Центр_Объекта.Позиция_Y, Радиус: Math.random() * 3, Цвет: "red", Скорость_По_X: (Math.random() * 3) - 2, Скорость_По_Y: (Math.random() * 3) - 2 }))
                }

                Деньги.Изменить_Количество(Math.round(Значение_Получить_Случайное(30, 80)))
                Враги[i].Состояние = "Мертв"
                Количество_Созданных_Врагов--
            }
        }
    }

    Объекты_В_Массиве_Обновить(Место_Постройки)
    Объекты_В_Массиве_Обновить(Башни_Купленные, Интервал_Времени)

    if (Массив_Эффекта_Уничтожения_Противника.length > 0) {
        Массив_Эффекта_Уничтожения_Противника.forEach((Эффект, Индекс) => {
            if (Эффект.Прозрачность <= 0) {
                Массив_Эффекта_Уничтожения_Противника.splice(Индекс, 1)
            }
            else {
                Эффект.Прозрачность -= 0.01
                Эффект.Обновить()
            }
        })
    }
}

function База_Проверка_Враг_Дошел_До_Базы() {
    for (let i = 0; i < Враги.length; i++) {
        if (Враги[i].Атлас.Позиция_X > Холст.width) {
            Массив_Удалить_Элемент(Враги, Враги[i])
            if (База.Здоровье > 0) {
                База.Здоровье--
            }
        }
    }

    if (База.Здоровье <= 0) {
        Игра_Проиграна()
    }
}

function Кадр_Обновить(Временная_Метка) {

    if (Игра_Состояние == "Игра") {

        Интервал_Времени = (Временная_Метка - Предыдущая_Временная_Метка) / 60
        Предыдущая_Временная_Метка = Временная_Метка
        Холст_Очистить()

        Карта.Отрисовать()

        if (Падающий_Листик)
            Падающий_Листик.Обновить()

        if (Эффекта_Ветра)
            Эффекта_Ветра.Обновить()

        Массивы_Обновить(Интервал_Времени)

        База_Проверка_Враг_Дошел_До_Базы()

        if (Панель)
            Панель.Обновить()

        Интерфейс_Игры()

        if (Количество_Созданных_Врагов <= 0) {
            Игра_Окончена()
        }
    }
    requestAnimationFrame(Кадр_Обновить)
}

function Игра_Начать() {
    Враги_Появление()
    Эффект_Карты_Обновлять_По_Очереди()
}

window.addEventListener("click", Интерфейс_Покупка_Башни_Открыть)
window.addEventListener("click", Интерфейс_Башни)
window.addEventListener("click", Башня_Улучшить)
window.addEventListener("click", Башня_Продать)
window.addEventListener("click", Перезапустить_Уровень)
window.addEventListener("click", Следущий_Уровень)

window.addEventListener("mousemove", function (Событие) {
    Мышь.Позиция_X = Событие.clientX
    Мышь.Позиция_Y = Событие.clientY
    Мышь.Коллайдер.Позиция_X = Событие.clientX
    Мышь.Коллайдер.Позиция_Y = Событие.clientY
})

window.addEventListener("mousedown", function () {
    Мышь.Клик = true
})

window.addEventListener("mouseup", function () {
    Мышь.Клик = false
})

    </script>
  </body>
</html>